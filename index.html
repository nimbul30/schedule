<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: 'Inter', sans-serif;
      }

      /* Dunham's Sports Logo Styling */
      .dunhams-logo {
        transition: transform 0.3s ease;
      }

      .dunhams-logo:hover {
        transform: scale(1.05);
      }

      .dunhams-text {
        font-family: 'Arial Black', Arial, sans-serif;
        font-weight: 900;
        fill: #e53e3e;
      }

      .dunhams-sports {
        font-family: Arial, sans-serif;
        font-weight: bold;
        fill: #e53e3e;
        letter-spacing: 3px;
      }
      .loader {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes slideIn {
        from {
          transform: translateX(-100%);
        }
        to {
          transform: translateX(0);
        }
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      #loader-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
        backdrop-filter: blur(2px);
      }
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 200;
        backdrop-filter: blur(3px);
      }
      .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 1rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
        width: 90%;
        max-width: 500px;
        position: relative;
        animation: fadeIn 0.3s ease-out;
        max-height: 90vh;
        overflow-y: auto;
      }
      .close-button {
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 1.5rem;
        font-weight: bold;
        color: #6b7280;
        cursor: pointer;
        transition: color 0.2s;
      }
      .close-button:hover {
        color: #374151;
      }
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        color: white;
        font-weight: 500;
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
        max-width: 400px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }
      .notification.success {
        background-color: #10b981;
      }
      .notification.error {
        background-color: #ef4444;
      }
      .notification.warning {
        background-color: #f59e0b;
      }
      .notification.info {
        background-color: #3b82f6;
      }
      .shift-cell {
        transition: all 0.2s ease;
      }
      .shift-cell:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }
      .employee-row {
        transition: background-color 0.2s ease;
      }
      .employee-row:hover {
        background-color: #f9fafb;
      }
      .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 1rem;
        animation: fadeIn 0.5s ease-out;
      }
      .quick-action-btn {
        transition: all 0.2s ease;
        transform: translateY(0);
      }
      .quick-action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }
      .schedule-table {
        border-collapse: separate;
        border-spacing: 0;
      }
      .schedule-table th,
      .schedule-table td {
        border: 1px solid #e5e7eb;
      }
      .schedule-table th:first-child,
      .schedule-table td:first-child {
        border-left: none;
      }
      .schedule-table th:last-child,
      .schedule-table td:last-child {
        border-right: none;
      }
      .schedule-table thead th {
        border-top: none;
      }
      .schedule-table tbody tr:last-child td {
        border-bottom: none;
      }
      .dark-mode {
        background-color: #1f2937;
        color: #f9fafb;
      }
      .dark-mode .bg-white {
        background-color: #374151 !important;
        color: #f9fafb;
      }
      .dark-mode .text-gray-800 {
        color: #f9fafb !important;
      }
      .dark-mode .text-gray-600 {
        color: #d1d5db !important;
      }
      .dark-mode .border-gray-200 {
        border-color: #4b5563 !important;
      }
      .theme-toggle {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 50;
        background: #4f46e5;
        color: white;
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        cursor: pointer;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
      }
      .theme-toggle:hover {
        transform: scale(1.1);
        background: #4338ca;
      }

      /* Shift Cell Styles */
      .shift-cell-empty {
        padding: 0.5rem;
        text-align: center;
        border: 2px dashed #d1d5db;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: all 0.2s;
        min-height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .shift-cell-empty:hover {
        border-color: #3b82f6;
        background-color: #eff6ff;
      }

      .shift-cell-custom,
      .shift-cell-predefined {
        padding: 0.5rem;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: all 0.2s;
        min-height: 60px;
      }

      .shift-cell-custom {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 2px solid #f59e0b;
      }

      .shift-cell-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.3);
      }

      .shift-cell-predefined {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border: 2px solid #3b82f6;
      }

      .shift-cell-predefined:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
      }

      /* Time Entry Modal Specific Styles */
      #time-entry-modal .modal-content {
        max-width: 500px;
      }

      #time-entry-modal input[type='time'] {
        font-size: 1rem;
        padding: 0.75rem;
      }

      #time-entry-modal input[type='radio'] {
        width: 1.25rem;
        height: 1.25rem;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <div id="loader-overlay"><div class="loader"></div></div>

    <!-- Admin Modal -->
    <div id="admin-modal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeAdminModal()">√ó</span>
        <div id="admin-form-container"></div>
      </div>
    </div>

    <!-- Unified Login Modal -->
    <div id="signin-modal" class="modal" style="display: flex">
      <div class="modal-content" style="max-width: 450px">
        <h2 class="text-3xl font-bold mb-2 text-gray-800 text-center">
          Dunham's Scheduler
        </h2>
        <p class="text-center text-gray-600 mb-6">Sign in to continue</p>

        <!-- Role Selection Tabs -->
        <div class="flex mb-6 bg-gray-100 rounded-lg p-1">
          <button
            id="manager-tab"
            onclick="switchLoginRole('manager')"
            class="flex-1 py-2 px-4 rounded-md font-semibold transition-all bg-white text-blue-600 shadow-sm"
          >
            Manager
          </button>
          <button
            id="employee-tab"
            onclick="switchLoginRole('employee')"
            class="flex-1 py-2 px-4 rounded-md font-semibold transition-all text-gray-600"
          >
            Employee
          </button>
        </div>

        <form id="signin-form">
          <!-- Username Field -->
          <div class="mb-4">
            <label
              class="block text-gray-700 text-sm font-bold mb-2"
              for="login-username"
            >
              <span id="username-label">Manager Name</span>
            </label>
            <input
              type="text"
              id="login-username"
              name="username"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
              placeholder="Enter your name"
            />
          </div>

          <!-- Password Field -->
          <div class="mb-6">
            <label
              class="block text-gray-700 text-sm font-bold mb-2"
              for="login-password"
            >
              Password
            </label>
            <div class="relative">
              <input
                type="password"
                id="login-password"
                name="password"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                placeholder="Enter your password"
              />
              <button
                type="button"
                onclick="togglePasswordVisibility()"
                class="absolute right-3 top-3 text-gray-500 hover:text-gray-700"
              >
                <span id="password-toggle-icon">üëÅÔ∏è</span>
              </button>
            </div>
            <p class="text-xs text-gray-500 mt-2" id="password-hint">
              Default manager password: <strong>admin123</strong>
            </p>
          </div>

          <!-- Error Message -->
          <div
            id="login-error"
            class="mb-4 p-3 bg-red-100 text-red-700 rounded-lg hidden"
          >
            Invalid credentials. Please try again.
          </div>

          <!-- Submit Button -->
          <button
            type="submit"
            class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-colors"
          >
            Sign In
          </button>
        </form>

        <!-- First Time Setup Link -->
        <div class="mt-4 text-center">
          <button
            onclick="showSetupInstructions()"
            class="text-sm text-blue-600 hover:text-blue-800 underline"
          >
            First time setup?
          </button>
        </div>
      </div>
    </div>

    <!-- Bulk Schedule Modal -->
    <div id="bulk-schedule-modal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeBulkScheduleModal()">√ó</span>
        <h2 class="text-2xl font-bold mb-6 text-gray-800">
          Bulk Schedule Assignment
        </h2>
        <form id="bulk-schedule-form">
          <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2"
              >Select Employees:</label
            >
            <div
              id="employee-checkboxes"
              class="max-h-40 overflow-y-auto border rounded p-3"
            >
              <!-- Employee checkboxes will be populated here -->
            </div>
          </div>
          <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2"
              >Select Shift:</label
            >
            <select
              id="bulk-shift-select"
              class="w-full p-2 border rounded"
              required
            >
              <option value="">Select a shift...</option>
            </select>
          </div>
          <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2"
              >Select Days:</label
            >
            <div class="grid grid-cols-7 gap-2">
              <label class="flex items-center"
                ><input type="checkbox" value="0" class="mr-1" /> Sun</label
              >
              <label class="flex items-center"
                ><input type="checkbox" value="1" class="mr-1" /> Mon</label
              >
              <label class="flex items-center"
                ><input type="checkbox" value="2" class="mr-1" /> Tue</label
              >
              <label class="flex items-center"
                ><input type="checkbox" value="3" class="mr-1" /> Wed</label
              >
              <label class="flex items-center"
                ><input type="checkbox" value="4" class="mr-1" /> Thu</label
              >
              <label class="flex items-center"
                ><input type="checkbox" value="5" class="mr-1" /> Fri</label
              >
              <label class="flex items-center"
                ><input type="checkbox" value="6" class="mr-1" /> Sat</label
              >
            </div>
          </div>
          <button
            type="submit"
            class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded"
          >
            Apply Bulk Schedule
          </button>
        </form>
      </div>
    </div>

    <!-- Template Modal -->
    <div id="template-modal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeTemplateModal()">√ó</span>
        <h2 class="text-2xl font-bold mb-6 text-gray-800">
          Schedule Templates
        </h2>
        <div class="mb-4">
          <button
            onclick="saveCurrentAsTemplate()"
            class="w-full mb-3 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded"
          >
            Save Current Week as Template
          </button>
        </div>
        <div id="template-list" class="space-y-2">
          <!-- Templates will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Analytics Modal -->
    <div id="analytics-modal" class="modal">
      <div class="modal-content" style="max-width: 800px">
        <span class="close-button" onclick="closeAnalyticsModal()">√ó</span>
        <h2 class="text-2xl font-bold mb-6 text-gray-800">
          Schedule Analytics
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="bg-gray-50 p-4 rounded-lg">
            <h3 class="font-bold mb-3">Employee Workload</h3>
            <div id="workload-chart" class="space-y-2">
              <!-- Workload data will be displayed here -->
            </div>
          </div>
          <div class="bg-gray-50 p-4 rounded-lg">
            <h3 class="font-bold mb-3">Shift Distribution</h3>
            <div id="shift-distribution" class="space-y-2">
              <!-- Shift distribution will be displayed here -->
            </div>
          </div>
          <div class="bg-gray-50 p-4 rounded-lg">
            <h3 class="font-bold mb-3">Coverage Analysis</h3>
            <div id="coverage-analysis">
              <!-- Coverage analysis will be displayed here -->
            </div>
          </div>
          <div class="bg-gray-50 p-4 rounded-lg">
            <h3 class="font-bold mb-3">Time Off Trends</h3>
            <div id="timeoff-trends">
              <!-- Time off trends will be displayed here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeSettingsModal()">√ó</span>
        <h2 class="text-2xl font-bold mb-6 text-gray-800">Settings</h2>
        <div class="space-y-4">
          <div>
            <label class="flex items-center">
              <input type="checkbox" id="auto-save" class="mr-2" />
              <span>Auto-save changes</span>
            </label>
          </div>
          <div>
            <label class="flex items-center">
              <input type="checkbox" id="email-notifications" class="mr-2" />
              <span>Email notifications</span>
            </label>
          </div>
          <div>
            <label class="block text-gray-700 text-sm font-bold mb-2"
              >Default Week View:</label
            >
            <select id="default-view" class="w-full p-2 border rounded">
              <option value="current">Current Week</option>
              <option value="next">Next Week</option>
            </select>
          </div>
          <div>
            <label class="block text-gray-700 text-sm font-bold mb-2"
              >Time Format:</label
            >
            <select id="time-format" class="w-full p-2 border rounded">
              <option value="12">12-hour (AM/PM)</option>
              <option value="24">24-hour</option>
            </select>
          </div>
          <button
            onclick="saveSettings()"
            class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded"
          >
            Save Settings
          </button>
        </div>
      </div>
    </div>

    <!-- Time Entry Modal -->
    <div id="time-entry-modal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeTimeEntryModal()">√ó</span>
        <h2 class="text-2xl font-bold mb-6 text-gray-800">Schedule Shift</h2>

        <!-- Employee and Date Info -->
        <div class="mb-4 p-3 bg-gray-50 rounded">
          <p>
            <strong>Employee:</strong> <span id="modal-employee-name"></span>
          </p>
          <p><strong>Date:</strong> <span id="modal-date"></span></p>
        </div>

        <!-- Mode Selector -->
        <div class="mb-4">
          <label class="block text-gray-700 text-sm font-bold mb-2"
            >Shift Type</label
          >
          <div class="flex space-x-4">
            <label class="flex items-center">
              <input
                type="radio"
                name="shift-mode"
                value="predefined"
                checked
                onchange="toggleShiftMode('predefined')"
                class="mr-2"
              />
              <span>Predefined Shift</span>
            </label>
            <label class="flex items-center">
              <input
                type="radio"
                name="shift-mode"
                value="custom"
                onchange="toggleShiftMode('custom')"
                class="mr-2"
              />
              <span>Custom Times</span>
            </label>
          </div>
        </div>

        <!-- Predefined Shift Selector -->
        <div id="predefined-shift-section" class="mb-4">
          <label class="block text-gray-700 text-sm font-bold mb-2"
            >Select Shift</label
          >
          <select
            id="modal-shift-select"
            class="w-full p-2 border rounded"
            onchange="updateTimePreview()"
          >
            <option value="">-- Select Shift --</option>
          </select>
        </div>

        <!-- Custom Time Entry -->
        <div id="custom-time-section" class="mb-4 hidden">
          <div class="grid grid-cols-2 gap-4 mb-3">
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2"
                >Clock In</label
              >
              <input
                type="time"
                id="custom-start-time"
                class="w-full p-2 border rounded"
                onchange="calculateCustomDuration()"
              />
            </div>
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2"
                >Clock Out</label
              >
              <input
                type="time"
                id="custom-end-time"
                class="w-full p-2 border rounded"
                onchange="calculateCustomDuration()"
              />
            </div>
          </div>
          <label class="flex items-center">
            <input
              type="checkbox"
              id="overnight-checkbox"
              class="mr-2"
              onchange="calculateCustomDuration()"
            />
            <span class="text-sm">This shift continues past midnight</span>
          </label>
        </div>

        <!-- Duration Display -->
        <div class="mb-6 p-3 bg-blue-50 rounded">
          <p class="text-sm text-gray-700">
            <strong>Duration:</strong>
            <span id="shift-duration" class="text-blue-900 font-bold">--</span>
          </p>
          <p id="time-range-display" class="text-xs text-gray-600 mt-1"></p>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-between">
          <button
            onclick="clearShift()"
            class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded"
          >
            Clear Shift
          </button>
          <div class="space-x-2">
            <button
              onclick="closeTimeEntryModal()"
              class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded"
            >
              Cancel
            </button>
            <button
              onclick="saveShiftAssignment()"
              class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded"
            >
              Save
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div
      id="delete-modal"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center"
      style="display: none; z-index: 300"
    >
      <div
        id="delete-modal-content"
        class="bg-white p-8 rounded-lg shadow-xl w-11/12 max-w-md mx-auto"
      >
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Confirm Deletion</h2>
        <p id="delete-modal-text" class="mb-4 text-gray-600">
          This action cannot be undone. This will permanently delete the
          employee and all their future scheduled shifts. Please type
          <strong class="text-red-600">delete</strong> to confirm.
        </p>
        <input
          type="text"
          id="delete-confirm-input"
          class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-4"
          placeholder="delete"
        />
        <div class="flex justify-end space-x-4">
          <button
            onclick="closeDeleteModal()"
            class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400 font-semibold"
          >
            Cancel
          </button>
          <button
            id="confirm-delete-btn"
            onclick="confirmEmployeeDeletion()"
            class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-semibold disabled:bg-red-300"
            disabled
          >
            Delete Employee
          </button>
        </div>
      </div>
    </div>

    <div class="container mx-auto p-4 md:p-8">
      <header
        class="bg-white p-6 rounded-lg shadow-lg border-b-4 border-red-500 mb-6"
      >
        <div class="flex flex-col md:flex-row justify-between items-center">
          <div class="flex items-center space-x-4 mb-4 md:mb-0">
            <div class="flex items-center">
              <svg width="120" height="40" viewBox="0 0 300 100" class="mr-3">
                <defs>
                  <style>
                    .logo-text {
                      fill: #e53e3e;
                      font-family: 'Arial Black', Arial, sans-serif;
                      font-weight: 900;
                    }
                    .logo-sports {
                      fill: #e53e3e;
                      font-family: Arial, sans-serif;
                      font-weight: bold;
                      letter-spacing: 3px;
                    }
                  </style>
                </defs>
                <text x="10" y="45" class="logo-text" font-size="32">
                  Dunham's
                </text>
                <text x="15" y="75" class="logo-sports" font-size="14">
                  S P O R T S
                </text>
              </svg>
            </div>
            <div class="border-l-2 border-gray-300 pl-4">
              <h1 class="text-xl md:text-2xl font-bold text-gray-800">
                Staff Scheduling
              </h1>
              <p class="text-gray-600 font-medium">
                Dunham's Sports Management
              </p>
              <p class="text-sm text-red-600 font-semibold">
                Manager Dashboard
              </p>
            </div>
          </div>
          <div class="flex items-center space-x-2 md:space-x-4">
            <div class="flex items-center space-x-3">
              <!-- User Avatar -->
              <div
                class="w-10 h-10 bg-gradient-to-br from-red-400 to-red-600 rounded-full flex items-center justify-center"
              >
                <svg
                  class="w-6 h-6 text-white"
                  fill="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"
                  />
                </svg>
              </div>
              <!-- User Info -->
              <div class="text-right">
                <p class="text-sm text-gray-600">Signed in as</p>
                <div class="flex items-center justify-end space-x-2">
                  <p class="font-semibold text-gray-900" id="current-user-name">
                    Loading...
                  </p>
                  <button
                    onclick="signOut()"
                    class="text-xs text-blue-600 hover:text-blue-800 underline"
                    title="Sign out and change user"
                  >
                    Sign Out
                  </button>
                </div>
              </div>
            </div>
            <button
              onclick="navigateWeek(-7)"
              class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold"
            >
              &lt; Prev
            </button>
            <h2 id="week-range" class="text-lg font-semibold text-center w-48">
              Loading...
            </h2>
            <button
              onclick="navigateWeek(7)"
              class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold"
            >
              Next &gt;
            </button>
          </div>
          <div
            class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 mt-4 md:mt-0"
          >
            <!-- Admin Buttons -->
            <button
              onclick="openAdminModal('employee')"
              class="w-full md:w-auto px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg shadow-sm"
            >
              Add Employee
            </button>
            <button
              onclick="openAdminModal('shift')"
              class="w-full md:w-auto px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-lg shadow-sm"
            >
              Add Shift
            </button>
            <button
              onclick="publishCurrentSchedule()"
              class="w-full md:w-auto px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-sm"
            >
              Publish Schedule
            </button>
          </div>
        </div>
      </header>

      <!-- Dashboard Stats -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
        <div class="stats-card">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm opacity-80">Total Employees</p>
              <p id="total-employees" class="text-3xl font-bold">-</p>
            </div>
            <div class="text-4xl opacity-60">üë•</div>
          </div>
        </div>
        <div
          class="stats-card"
          style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%)"
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm opacity-80">Scheduled This Week</p>
              <p id="scheduled-count" class="text-3xl font-bold">-</p>
            </div>
            <div class="text-4xl opacity-60">üìÖ</div>
          </div>
        </div>
        <div
          class="stats-card"
          style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)"
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm opacity-80">Pending Requests</p>
              <p id="pending-count" class="text-3xl font-bold">-</p>
            </div>
            <div class="text-4xl opacity-60">‚è≥</div>
          </div>
        </div>
        <div
          class="stats-card"
          style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)"
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm opacity-80">Total Store Hours</p>
              <p id="total-store-hours" class="text-3xl font-bold">-</p>
            </div>
            <div class="text-4xl opacity-60">‚è∞</div>
          </div>
        </div>
        <div
          class="stats-card"
          style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)"
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm opacity-80">Coverage Rate</p>
              <p id="coverage-rate" class="text-3xl font-bold">-%</p>
            </div>
            <div class="text-4xl opacity-60">üìä</div>
          </div>
        </div>
      </div>

      <!-- Manager's Hours Calculator -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h3 class="text-lg font-bold text-gray-800 mb-4">
          üìä Manager's Hours Calculator
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <!-- Available Hours Input -->
          <div class="bg-blue-50 p-4 rounded-lg">
            <label
              for="available-hours"
              class="block text-sm font-medium text-blue-700 mb-2"
            >
              Total Available Hours This Week
            </label>
            <input
              type="number"
              id="available-hours"
              class="w-full p-3 border border-blue-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
              placeholder="Enter available hours"
              min="0"
              step="0.5"
              onchange="calculateHoursBalance()"
            />
            <p class="text-xs text-blue-600 mt-1">
              Enter the total hours you have available to schedule
            </p>
          </div>

          <!-- Scheduled Hours Display -->
          <div class="bg-green-50 p-4 rounded-lg">
            <label class="block text-sm font-medium text-green-700 mb-2">
              Currently Scheduled Hours
            </label>
            <div
              class="text-2xl font-bold text-green-900"
              id="manager-scheduled-hours"
            >
              0.0
            </div>
            <p class="text-xs text-green-600 mt-1">
              Total hours currently scheduled for all employees
            </p>
          </div>

          <!-- Balance Display -->
          <div class="bg-yellow-50 p-4 rounded-lg">
            <label class="block text-sm font-medium text-yellow-700 mb-2">
              Hours Balance
            </label>
            <div class="text-2xl font-bold" id="hours-balance">0.0</div>
            <p class="text-xs text-yellow-600 mt-1" id="balance-status">
              Enter available hours to see balance
            </p>
          </div>
        </div>

        <!-- Quick Actions Row -->
        <div class="mt-6 pt-6 border-t border-gray-200">
          <div class="flex flex-wrap gap-4">
            <button
              onclick="suggestOptimalSchedule()"
              class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors"
            >
              üéØ Suggest Optimal Schedule
            </button>
            <button
              onclick="exportHoursReport()"
              class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors"
            >
              üìä Export Hours Report
            </button>
            <button
              onclick="resetHoursCalculator()"
              class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-medium transition-colors"
            >
              üîÑ Reset Calculator
            </button>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Quick Actions</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
          <button
            onclick="openBulkScheduleModal()"
            class="quick-action-btn flex flex-col items-center p-4 bg-purple-100 hover:bg-purple-200 rounded-lg text-purple-700"
          >
            <span class="text-2xl mb-2">‚ö°</span>
            <span class="text-sm font-medium">Bulk Schedule</span>
          </button>
          <button
            onclick="exportSchedule()"
            class="quick-action-btn flex flex-col items-center p-4 bg-blue-100 hover:bg-blue-200 rounded-lg text-blue-700"
          >
            <span class="text-2xl mb-2">üì§</span>
            <span class="text-sm font-medium">Export</span>
          </button>
          <button
            onclick="openTemplateModal()"
            class="quick-action-btn flex flex-col items-center p-4 bg-green-100 hover:bg-green-200 rounded-lg text-green-700"
          >
            <span class="text-2xl mb-2">üìã</span>
            <span class="text-sm font-medium">Templates</span>
          </button>
          <button
            onclick="openAnalyticsModal()"
            class="quick-action-btn flex flex-col items-center p-4 bg-yellow-100 hover:bg-yellow-200 rounded-lg text-yellow-700"
          >
            <span class="text-2xl mb-2">üìà</span>
            <span class="text-sm font-medium">Analytics</span>
          </button>
          <button
            onclick="openNotificationCenter()"
            class="quick-action-btn flex flex-col items-center p-4 bg-red-100 hover:bg-red-200 rounded-lg text-red-700"
          >
            <span class="text-2xl mb-2">üîî</span>
            <span class="text-sm font-medium">Notifications</span>
          </button>
          <button
            onclick="openSettingsModal()"
            class="quick-action-btn flex flex-col items-center p-4 bg-gray-100 hover:bg-gray-200 rounded-lg text-gray-700"
          >
            <span class="text-2xl mb-2">‚öôÔ∏è</span>
            <span class="text-sm font-medium">Settings</span>
          </button>
        </div>
      </div>

      <!-- Time Off Requests Section -->
      <div class="mb-8">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold text-gray-700">
            Pending Time Off Requests
          </h2>
          <button
            onclick="openTimeOffHistoryModal()"
            class="px-4 py-2 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-lg font-medium transition-colors"
          >
            View History
          </button>
        </div>
        <div
          id="pending-requests-container"
          class="bg-white rounded-lg shadow-md"
        >
          <!-- Pending requests will be inserted here -->
        </div>
      </div>

      <!-- Schedule Section -->
      <h2 class="text-xl font-bold text-gray-700 mb-4">Weekly Schedule</h2>
      <main class="bg-white rounded-lg shadow-md overflow-x-auto">
        <table
          id="schedule-table"
          class="min-w-full divide-y divide-gray-200"
        ></table>
      </main>
    </div>

    <!-- Theme Toggle Button -->
    <button
      id="theme-toggle"
      class="theme-toggle"
      onclick="toggleTheme()"
      title="Toggle Dark Mode"
    >
      üåô
    </button>

    <!-- Notification Container -->
    <div
      id="notification-container"
      style="position: fixed; top: 20px; right: 20px; z-index: 1000"
    ></div>

    <script>
      let currentStartDate;
      let allShifts = [];
      let allEmployees = [];
      let employeeToDeleteEmail = null;
      let scheduleData = {};
      let appSettings = {
        autoSave: true,
        emailNotifications: true,
        defaultView: 'current',
        timeFormat: '12',
        darkMode: false,
      };

      // Modal context for time entry modal
      let currentModalContext = {
        employeeName: null,
        date: null,
        existingAssignment: null,
      };

      // Helper function to normalize schedule assignments for backward compatibility
      function normalizeScheduleAssignment(assignment) {
        if (!assignment) return null;

        return {
          ...assignment,
          isCustom:
            assignment.isCustom !== undefined ? assignment.isCustom : false,
          isOvernight:
            assignment.isOvernight !== undefined
              ? assignment.isOvernight
              : false,
        };
      }

      function startApp() {
        console.log('Starting standalone app...');
        initializeApp();
      }

      function initializeApp() {
        console.log('Initializing app...');

        loadUserFromTemplate();

        // Calculate current week start (Monday)
        const today = new Date();
        const dayOfWeek = today.getDay();
        const startDate = new Date(today);
        startDate.setHours(0, 0, 0, 0);
        const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
        startDate.setDate(startDate.getDate() - daysFromMonday);

        currentStartDate = startDate;

        console.log('Current week start (Sunday):', startDate.toDateString());
        console.log(
          'Week will span:',
          startDate.toDateString(),
          'to',
          new Date(startDate.getTime() + 6 * 24 * 60 * 60 * 1000).toDateString()
        );

        // Initialize default data if not exists
        console.log('About to initialize default data');
        initializeDefaultData();

        console.log('About to load schedule for date:', currentStartDate);
        loadScheduleForDate(currentStartDate);
        console.log('About to load pending requests');
        loadPendingRequests();
      }

      function testServerConnection() {
        console.log('Testing server connection...');

        // Test the simple function first
        google.script.run
          .withSuccessHandler((response) => {
            console.log('Simple test response:', response);
          })
          .withFailureHandler((error) => {
            console.error('Simple test failed:', error);
          })
          .simpleTest();

        // Then test the server connection
        google.script.run
          .withSuccessHandler((response) => {
            console.log('Server test response:', response);
          })
          .withFailureHandler((error) => {
            console.error('Server test failed:', error);
          })
          .testServerConnection();
      }

      document.addEventListener('DOMContentLoaded', startApp);

      // Removed loadCurrentUser - not needed in standalone mode

      function showLoader() {
        document.getElementById('loader-overlay').style.display = 'flex';
      }
      function hideLoader() {
        document.getElementById('loader-overlay').style.display = 'none';
      }

      // --- Schedule Functions ---
      function navigateWeek(days) {
        // Create a new date object to avoid mutation issues
        const newStartDate = new Date(currentStartDate.getTime());

        // Add the days (should be +7 or -7 for week navigation)
        newStartDate.setDate(newStartDate.getDate() + days);

        // Ensure we're still at the start of the week (Sunday)
        const dayOfWeek = newStartDate.getDay();
        newStartDate.setDate(newStartDate.getDate() - dayOfWeek);

        currentStartDate = newStartDate;

        console.log(
          'Navigating to week starting:',
          currentStartDate.toDateString()
        );

        loadScheduleForDate(currentStartDate);
      }

      function loadScheduleForDate(date) {
        console.log(
          'Loading schedule for date:',
          date.toDateString(),
          'Timestamp:',
          date.getTime()
        );

        showLoader();

        // Create week range string
        const endDate = new Date(date);
        endDate.setDate(date.getDate() + 6);
        const weekRange = `${date.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;

        // Load data from localStorage
        const employees = JSON.parse(localStorage.getItem('employees') || '[]');
        const shifts = JSON.parse(localStorage.getItem('shifts') || '[]');
        const rawSchedule = JSON.parse(
          localStorage.getItem('schedule') || '[]'
        );
        const approvedRequests = JSON.parse(
          localStorage.getItem('approvedRequests') || '[]'
        );

        // Normalize schedule data for backward compatibility
        const schedule = rawSchedule.map((assignment) =>
          normalizeScheduleAssignment(assignment)
        );

        // Build the response object
        const response = {
          success: true,
          employees,
          shifts,
          schedule,
          weekRange,
          approvedRequests,
        };

        buildScheduleGrid(response);
        hideLoader();
      }

      function buildScheduleGrid(data) {
        console.log('Building schedule grid with data:', data);
        const { employees, shifts, schedule, weekRange, approvedRequests } =
          data;
        allShifts = shifts || [];
        allEmployees = employees || [];
        scheduleData = data;
        console.log('allShifts:', allShifts);
        console.log('allEmployees:', allEmployees);

        // Update dashboard stats (with error handling that doesn't stop table building)
        try {
          console.log('About to update dashboard stats');
          updateDashboardStats(data);
          console.log('Dashboard stats updated');
        } catch (error) {
          console.error(
            'Error updating dashboard stats (continuing with table):',
            error
          );
        }

        console.log('Starting to build schedule table...');
        document.getElementById('week-range').textContent = weekRange;
        const table = document.getElementById('schedule-table');
        table.innerHTML = '';
        const thead = table.createTHead();
        const headerRow = thead.insertRow();
        headerRow.className = 'bg-gray-50';
        let th = document.createElement('th');
        th.className =
          'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
        th.textContent = 'Staff';
        headerRow.appendChild(th);
        const dateColumns = [];
        for (let i = 0; i < 7; i++) {
          const d = new Date(currentStartDate);
          d.setDate(d.getDate() + i);
          dateColumns.push(d.toISOString().split('T')[0]);
          th = document.createElement('th');
          th.className =
            'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
          th.textContent = d.toLocaleDateString('en-US', {
            weekday: 'short',
            month: 'short',
            day: 'numeric',
          });
          headerRow.appendChild(th);
        }
        // Add Weekly Hours column
        th = document.createElement('th');
        th.className =
          'px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider bg-blue-50';
        th.textContent = 'Weekly Hours';
        headerRow.appendChild(th);
        const tbody = table.createTBody();
        tbody.className = 'bg-white divide-y divide-gray-200';
        if (!employees || employees.length === 0) {
          const row = tbody.insertRow();
          const cell = row.insertCell();
          cell.colSpan = 9; // Updated to include the new Weekly Hours column
          cell.className = 'px-6 py-10 text-center text-gray-500';
          cell.textContent =
            'No employees found. Click "Add Employee" to begin.';
        } else {
          employees.forEach((emp) => {
            const row = tbody.insertRow();
            let cell = row.insertCell();
            cell.className =
              'px-6 py-4 whitespace-nowrap flex justify-between items-center';
            cell.innerHTML = `
              <div>
                <div class="font-medium text-gray-900">${emp.name}</div>
                <div class="text-sm text-gray-500">${emp.role}</div>
              </div>
              <button onclick="openDeleteModal('${emp.name}', '${emp.email}')" class="ml-4 px-2 py-1 text-xs font-medium text-red-600 bg-red-100 rounded-md hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                  Delete
              </button>
            `;

            dateColumns.forEach((date) => {
              cell = row.insertCell();
              cell.className = 'px-6 py-4 whitespace-nowrap';
              const dateParts = date.split('-');
              const currentDate = new Date(
                Date.UTC(dateParts[0], dateParts[1] - 1, dateParts[2])
              );

              const isOnLeave =
                approvedRequests &&
                approvedRequests.some((req) => {
                  const startDate = new Date(req.startDate);
                  const endDate = new Date(req.endDate);
                  return (
                    emp.email === req.employeeEmail &&
                    currentDate >= startDate &&
                    currentDate <= endDate
                  );
                });

              if (isOnLeave) {
                cell.innerHTML = `<div class="p-2 text-center font-semibold text-white bg-green-500 rounded-md">Time Off</div>`;
                cell.className += ' bg-green-100';
              } else {
                const assignment = schedule.find(
                  (s) => s.employeeName === emp.name && s.date === date
                );
                cell.innerHTML = createShiftCell(
                  emp.name,
                  date,
                  assignment || null
                );
              }
            });

            // Add Weekly Hours cell
            cell = row.insertCell();
            cell.className =
              'px-6 py-4 whitespace-nowrap text-center bg-blue-50';
            const weeklyHours = calculateEmployeeWeeklyHours(
              emp.name,
              schedule,
              shifts
            );
            cell.innerHTML = `<div class="font-semibold text-blue-900">${weeklyHours}h</div>`;
          });
        }
        console.log('buildScheduleGrid completed successfully');
      }

      // Calculate weekly hours for an employee
      function calculateEmployeeWeeklyHours(employeeName, schedule) {
        return calculateEmployeeHours(employeeName, schedule, allShifts);
      }

      function createShiftCell(employeeName, date, assignment) {
        // Escape function for JSON data in HTML attributes
        const escapeJSON = (obj) => {
          return JSON.stringify(obj)
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
        };

        if (!assignment) {
          // Empty cell - show clickable placeholder
          return `<div class="shift-cell-empty" onclick="openTimeEntryModal('${employeeName}', '${date}', null)">
                    <span class="text-gray-400 text-sm">+ Add Shift</span>
                  </div>`;
        } else if (assignment.isCustom) {
          // Custom time assignment - show time range
          const hours = calculateShiftHours(
            assignment.start,
            assignment.end,
            assignment.isOvernight
          );
          const overnightBadge = assignment.isOvernight
            ? '<span class="text-xs">üåô</span>'
            : '';
          const assignmentJSON = escapeJSON(assignment);
          return `<div class="shift-cell-custom" onclick='openTimeEntryModal("${employeeName}", "${date}", JSON.parse("${assignmentJSON}"))'>
                    <div class="font-medium text-sm">${assignment.start} - ${assignment.end} ${overnightBadge}</div>
                    <div class="text-xs text-gray-600">${hours}h</div>
                  </div>`;
        } else {
          // Predefined shift - show shift name
          const shift = allShifts.find((s) => s.name === assignment.shiftName);
          const hours = shift ? calculateShiftHours(shift.start, shift.end) : 0;
          const assignmentJSON = escapeJSON(assignment);
          return `<div class="shift-cell-predefined" onclick='openTimeEntryModal("${employeeName}", "${date}", JSON.parse("${assignmentJSON}"))'>
                    <div class="font-medium text-sm">${assignment.shiftName}</div>
                    <div class="text-xs text-gray-600">${assignment.start} - ${assignment.end} (${hours}h)</div>
                  </div>`;
        }
      }

      function handleShiftChange(selectElement, employeeName, date) {
        const shiftName = selectElement.value;

        // Get current schedule
        let schedule = JSON.parse(localStorage.getItem('schedule') || '[]');

        // Remove existing assignment for this employee and date
        schedule = schedule.filter(
          (s) => !(s.employeeName === employeeName && s.date === date)
        );

        // Add new assignment if a shift was selected
        if (shiftName) {
          const shift = allShifts.find((s) => s.name === shiftName);
          if (shift) {
            schedule.push({
              employeeName: employeeName,
              date: date,
              shiftName: shiftName,
              start: shift.start,
              end: shift.end,
            });
          }
        }

        // Save updated schedule
        localStorage.setItem('schedule', JSON.stringify(schedule));

        // Refresh the schedule to update weekly hours
        loadScheduleForDate(currentStartDate);
      }

      function publishCurrentSchedule() {
        if (
          confirm(
            'Are you sure you want to publish the schedule for the current week? This will create a new sheet in your Google Spreadsheet.'
          )
        ) {
          showLoader();
          google.script.run
            .withSuccessHandler((response) => {
              hideLoader();
              if (response.success) {
                alert(response.message);
              } else {
                handleFailure(response);
              }
            })
            .withFailureHandler(handleFailure)
            .publishSchedule(currentStartDate.getTime());
        }
      }

      // --- Admin Modal Functions ---
      function openAdminModal(formType) {
        const modal = document.getElementById('admin-modal');
        const formContainer = document.getElementById('admin-form-container');

        // Generate the appropriate form based on formType
        let formHtml = '';
        if (formType === 'employee') {
          formHtml = `
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Add New Employee</h2>
            <form id="add-employee-form">
              <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="employee-name">
                  Employee Name
                </label>
                <input
                  type="text"
                  id="employee-name"
                  name="name"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                  placeholder="Enter employee name"
                >
              </div>
              <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="employee-email">
                  Email (Optional)
                </label>
                <input
                  type="email"
                  id="employee-email"
                  name="email"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                  placeholder="Enter email address"
                >
              </div>
              <div class="mb-6">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="employee-role">
                  Role (Optional)
                </label>
                <input
                  type="text"
                  id="employee-role"
                  name="role"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                  placeholder="Enter role/position"
                >
              </div>
              <div class="flex justify-end space-x-3">
                <button
                  type="button"
                  onclick="closeAdminModal()"
                  class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg"
                >
                  Add Employee
                </button>
              </div>
            </form>
          `;
        } else if (formType === 'shift') {
          formHtml = `
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Add New Shift</h2>
            <form id="add-shift-form">
              <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="shift-name">
                  Shift Name
                </label>
                <input
                  type="text"
                  id="shift-name"
                  name="name"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                  placeholder="Enter shift name"
                >
              </div>
              <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="shift-start">
                  Start Time
                </label>
                <input
                  type="time"
                  id="shift-start"
                  name="startTime"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                >
              </div>
              <div class="mb-6">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="shift-end">
                  End Time
                </label>
                <input
                  type="time"
                  id="shift-end"
                  name="endTime"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                >
              </div>
              <div class="flex justify-end space-x-3">
                <button
                  type="button"
                  onclick="closeAdminModal()"
                  class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg"
                >
                  Add Shift
                </button>
              </div>
            </form>
          `;
        }

        formContainer.innerHTML = formHtml;
        modal.style.display = 'flex';

        // Add form submit handler
        const form = formContainer.querySelector('form');
        if (form) {
          form.addEventListener('submit', handleAdminFormSubmit);
        }
      }

      function closeAdminModal() {
        const modal = document.getElementById('admin-modal');
        modal.style.display = 'none';
        document.getElementById('admin-form-container').innerHTML = '';
      }

      function handleAdminFormSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const formObject = {};
        formData.forEach((value, key) => {
          formObject[key] = value;
        });

        // Handle employee form
        if (form.id === 'add-employee-form') {
          if (!formObject.name || formObject.name.trim() === '') {
            alert('Please enter an employee name.');
            return;
          }

          // Add employee to the employees array
          const newEmployee = {
            name: formObject.name.trim(),
            email: formObject.email || '',
            role: formObject.role || '',
          };

          employees.push(newEmployee);

          // Save to localStorage
          localStorage.setItem('employees', JSON.stringify(employees));

          alert(`Employee "${newEmployee.name}" has been added successfully!`);
          closeAdminModal();
          loadScheduleForDate(currentStartDate);
        }

        // Handle shift form
        else if (form.id === 'add-shift-form') {
          if (!formObject.name || formObject.name.trim() === '') {
            alert('Please enter a shift name.');
            return;
          }
          if (!formObject.startTime || !formObject.endTime) {
            alert('Please enter both start and end times.');
            return;
          }

          // Add shift to the shifts array
          const newShift = {
            name: formObject.name.trim(),
            start: formObject.startTime,
            end: formObject.endTime,
            startTime: formObject.startTime, // Keep both for compatibility
            endTime: formObject.endTime,
          };

          shifts.push(newShift);

          // Save to localStorage
          localStorage.setItem('shifts', JSON.stringify(shifts));

          alert(`Shift "${newShift.name}" has been added successfully!`);
          closeAdminModal();
          loadScheduleForDate(currentStartDate);
        }
      }

      // --- Manager Time Off Request Functions ---
      function loadPendingRequests() {
        // Load pending requests from localStorage
        const pendingRequests = JSON.parse(
          localStorage.getItem('pendingRequests') || '[]'
        );

        const response = {
          success: true,
          requests: pendingRequests,
        };

        buildPendingRequestsView(response);

        // Update the pending count in dashboard
        document.getElementById('pending-count').textContent =
          pendingRequests.length;
      }

      // --- Delete Employee Functions ---
      function openDeleteModal(employeeName, employeeEmail) {
        employeeToDeleteEmail = employeeEmail;
        const modal = document.getElementById('delete-modal');
        document.getElementById(
          'delete-modal-text'
        ).innerHTML = `This action cannot be undone. This will permanently delete <strong>${employeeName}</strong> and all their future scheduled shifts. Please type <strong class="text-red-600">delete</strong> to confirm.`;
        modal.style.display = 'flex';

        const deleteInput = document.getElementById('delete-confirm-input');
        const confirmBtn = document.getElementById('confirm-delete-btn');
        deleteInput.value = '';
        confirmBtn.disabled = true;

        deleteInput.oninput = function () {
          if (deleteInput.value.trim().toLowerCase() === 'delete') {
            confirmBtn.disabled = false;
          } else {
            confirmBtn.disabled = true;
          }
        };
      }

      function closeDeleteModal() {
        document.getElementById('delete-modal').style.display = 'none';
        employeeToDeleteEmail = null;
      }

      function confirmEmployeeDeletion() {
        if (!employeeToDeleteEmail) {
          alert('Error: No employee selected for deletion.');
          closeDeleteModal();
          return;
        }

        showLoader();
        google.script.run
          .withSuccessHandler((response) => {
            hideLoader();
            if (response.success) {
              alert(response.message);
              closeDeleteModal();
              loadScheduleForDate(currentStartDate);
            } else {
              handleFailure(response);
            }
          })
          .withFailureHandler(handleFailure)
          .deleteEmployee(employeeToDeleteEmail);
      }

      // Fallback function to load user from template data
      function loadUserFromTemplate() {
        console.log('Checking authentication status...');

        // Check localStorage for authenticated user
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
          try {
            const user = JSON.parse(savedUser);
            if (user && user.name && user.role) {
              const userNameElement =
                document.getElementById('current-user-name');
              if (userNameElement) {
                userNameElement.textContent = user.name;
                console.log(
                  'Authenticated user loaded:',
                  user.name,
                  'Role:',
                  user.role
                );
                return true;
              } else {
                console.error('current-user-name element not found');
              }
            }
          } catch (e) {
            console.error('Error parsing saved user:', e);
          }
        }

        // No authenticated user found - show sign-in modal
        console.log('No authenticated user found, showing sign-in modal');
        const userNameElement = document.getElementById('current-user-name');
        if (userNameElement) {
          userNameElement.textContent = 'Please Sign In';
        }
        showSignInModal();
        return false;
      }

      // Current login role (manager or employee)
      let currentLoginRole = 'manager';

      function showSignInModal() {
        const modal = document.getElementById('signin-modal');
        modal.style.display = 'flex';
        switchLoginRole('manager'); // Default to manager tab
      }

      function closeSignInModal() {
        const modal = document.getElementById('signin-modal');
        modal.style.display = 'none';
        document.getElementById('login-error').classList.add('hidden');
      }

      function switchLoginRole(role) {
        currentLoginRole = role;
        const managerTab = document.getElementById('manager-tab');
        const employeeTab = document.getElementById('employee-tab');
        const usernameLabel = document.getElementById('username-label');
        const passwordHint = document.getElementById('password-hint');
        const usernameInput = document.getElementById('login-username');

        if (role === 'manager') {
          managerTab.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
          managerTab.classList.remove('text-gray-600');
          employeeTab.classList.remove(
            'bg-white',
            'text-blue-600',
            'shadow-sm'
          );
          employeeTab.classList.add('text-gray-600');
          usernameLabel.textContent = 'Manager Name';
          usernameInput.placeholder = 'Enter your name';
          passwordHint.innerHTML =
            'Default manager password: <strong>admin123</strong>';
        } else {
          employeeTab.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
          employeeTab.classList.remove('text-gray-600');
          managerTab.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
          managerTab.classList.add('text-gray-600');
          usernameLabel.textContent = 'Employee Name';
          usernameInput.placeholder = 'Enter your name';
          passwordHint.innerHTML =
            'Default employee password: <strong>employee123</strong>';
        }

        document.getElementById('login-error').classList.add('hidden');
      }

      function togglePasswordVisibility() {
        const passwordInput = document.getElementById('login-password');
        const toggleIcon = document.getElementById('password-toggle-icon');

        if (passwordInput.type === 'password') {
          passwordInput.type = 'text';
          toggleIcon.textContent = 'üôà';
        } else {
          passwordInput.type = 'password';
          toggleIcon.textContent = 'üëÅÔ∏è';
        }
      }

      function showSetupInstructions() {
        const message = `
First Time Setup Instructions:

MANAGER ACCESS:
- Username: Your name
- Password: admin123 (default)

EMPLOYEE ACCESS:
- Username: Your name  
- Password: employee123 (default)

To change passwords:
1. Sign in as manager
2. Go to Settings (coming soon)
3. Update passwords

Note: Passwords are stored locally in your browser.
        `;
        alert(message);
      }

      function getStoredCredentials() {
        const stored = localStorage.getItem('userCredentials');
        if (stored) {
          return JSON.parse(stored);
        }
        // Default credentials
        return {
          managers: {
            admin123: true, // Default manager password
          },
          employees: {
            employee123: true, // Default employee password
          },
        };
      }

      function validateCredentials(username, password, role) {
        const credentials = getStoredCredentials();

        if (role === 'manager') {
          return credentials.managers[password] === true;
        } else {
          return credentials.employees[password] === true;
        }
      }

      function handleSignIn(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const username = formData.get('username').trim();
        const password = formData.get('password').trim();
        const errorDiv = document.getElementById('login-error');

        if (!username || !password) {
          errorDiv.textContent = 'Please enter both username and password.';
          errorDiv.classList.remove('hidden');
          return;
        }

        // Validate credentials
        if (!validateCredentials(username, password, currentLoginRole)) {
          errorDiv.textContent = 'Invalid credentials. Please try again.';
          errorDiv.classList.remove('hidden');
          console.log('Login failed for:', username, 'Role:', currentLoginRole);
          return;
        }

        // Successful login
        const user = {
          name: username,
          role: currentLoginRole,
          loginTime: new Date().toISOString(),
        };
        localStorage.setItem('currentUser', JSON.stringify(user));
        document.getElementById('current-user-name').textContent = username;
        closeSignInModal();
        console.log('User signed in:', username, 'Role:', currentLoginRole);
        showNotification(`Welcome ${username}!`, 'success');

        // If employee, redirect to employee view (if available)
        if (currentLoginRole === 'employee') {
          // You can implement employee view here
          console.log('Employee view not yet implemented');
        }
      }

      function signOut() {
        const currentUser = JSON.parse(
          localStorage.getItem('currentUser') || '{}'
        );
        localStorage.removeItem('currentUser');
        document.getElementById('current-user-name').textContent =
          'Please Sign In';
        showSignInModal();
        console.log('User signed out:', currentUser.name);
        showNotification('Signed out successfully', 'info');
      }

      // --- Time Calculation Functions ---
      function calculateShiftHours(startTime, endTime, isOvernight = false) {
        if (!startTime || !endTime) return 0;

        const start = new Date(`2000-01-01 ${startTime}`);
        const end = new Date(`2000-01-01 ${endTime}`);

        let hours = (end - start) / (1000 * 60 * 60);

        // Handle overnight shifts (end time is next day)
        if (isOvernight || hours < 0) {
          hours += 24;
        }

        return Math.round(hours * 100) / 100; // Round to 2 decimal places
      }

      function calculateTotalScheduledHours(schedule, shifts) {
        let totalHours = 0;

        schedule.forEach((assignment) => {
          if (assignment.shiftName && assignment.shiftName !== 'Time Off') {
            // Handle custom shifts by reading start/end times directly
            if (assignment.isCustom) {
              totalHours += calculateShiftHours(
                assignment.start,
                assignment.end,
                assignment.isOvernight || false
              );
            } else {
              // Handle predefined shifts by looking up shift details
              const shift = shifts.find((s) => s.name === assignment.shiftName);
              if (shift) {
                totalHours += calculateShiftHours(shift.start, shift.end);
              }
            }
          }
        });

        return Math.round(totalHours * 100) / 100;
      }

      function calculateEmployeeHours(employeeName, schedule, shifts) {
        let employeeHours = 0;

        schedule.forEach((assignment) => {
          if (
            assignment.employeeName === employeeName &&
            assignment.shiftName &&
            assignment.shiftName !== 'Time Off'
          ) {
            // Handle custom shifts
            if (assignment.isCustom) {
              employeeHours += calculateShiftHours(
                assignment.start,
                assignment.end,
                assignment.isOvernight || false
              );
            } else {
              // Handle predefined shifts
              const shift = shifts.find((s) => s.name === assignment.shiftName);
              if (shift) {
                employeeHours += calculateShiftHours(shift.start, shift.end);
              }
            }
          }
        });

        return Math.round(employeeHours * 100) / 100;
      }

      // --- Enhanced Features ---

      function initializeDefaultData() {
        // Initialize default shifts if none exist
        let shifts = JSON.parse(localStorage.getItem('shifts') || '[]');
        if (shifts.length === 0) {
          const defaultShifts = [
            {
              name: 'Morning Shift',
              start: '08:00',
              end: '16:00',
              startTime: '08:00',
              endTime: '16:00',
            },
            {
              name: 'Afternoon Shift',
              start: '12:00',
              end: '20:00',
              startTime: '12:00',
              endTime: '20:00',
            },
            {
              name: 'Evening Shift',
              start: '16:00',
              end: '22:00',
              startTime: '16:00',
              endTime: '22:00',
            },
            {
              name: 'Part-Time Morning',
              start: '09:00',
              end: '13:00',
              startTime: '09:00',
              endTime: '13:00',
            },
            {
              name: 'Part-Time Evening',
              start: '17:00',
              end: '21:00',
              startTime: '17:00',
              endTime: '21:00',
            },
          ];

          localStorage.setItem('shifts', JSON.stringify(defaultShifts));
          console.log('Default shifts initialized');
        }

        // Initialize default employees if none exist
        let employees = JSON.parse(localStorage.getItem('employees') || '[]');
        if (employees.length === 0) {
          const defaultEmployees = [
            {
              name: 'John Smith',
              email: 'john@example.com',
              role: 'Sales Associate',
            },
            {
              name: 'Sarah Johnson',
              email: 'sarah@example.com',
              role: 'Cashier',
            },
            {
              name: 'Mike Wilson',
              email: 'mike@example.com',
              role: 'Stock Associate',
            },
          ];

          localStorage.setItem('employees', JSON.stringify(defaultEmployees));
          console.log('Default employees initialized');
        }
      }

      // Dashboard Statistics
      function updateDashboardStats(data) {
        try {
          console.log('updateDashboardStats called with:', data);
          const { employees, schedule, shifts, approvedRequests } = data;

          console.log('Updating total employees');
          const totalEmployeesEl = document.getElementById('total-employees');
          if (totalEmployeesEl) {
            totalEmployeesEl.textContent = employees.length;
          }

          console.log('Updating scheduled count');
          const scheduledCountEl = document.getElementById('scheduled-count');
          if (scheduledCountEl) {
            scheduledCountEl.textContent = schedule.length;
          }

          console.log('Updating pending count');
          const pendingCountEl = document.getElementById('pending-count');
          if (pendingCountEl) {
            pendingCountEl.textContent = '...'; // Will be updated by loadPendingRequests
          }

          // Calculate total store hours for the week using new function
          console.log('Calculating total store hours');
          const totalStoreHours = calculateTotalScheduledHours(
            schedule,
            shifts
          );
          console.log('Total store hours:', totalStoreHours);

          const totalStoreHoursEl =
            document.getElementById('total-store-hours');
          if (totalStoreHoursEl) {
            totalStoreHoursEl.textContent = totalStoreHours;
          }

          // Update manager's scheduled hours
          const managerScheduledHoursEl = document.getElementById(
            'manager-scheduled-hours'
          );
          if (managerScheduledHoursEl) {
            managerScheduledHoursEl.textContent = totalStoreHours;
          }

          // Calculate hours balance if available hours is set
          console.log('Calculating hours balance');
          calculateHoursBalance();
          console.log('Hours balance calculated');
        } catch (error) {
          console.error('Error in updateDashboardStats:', error);
          // Don't throw - let the table still be built
        }

        // Calculate coverage rate
        const totalPossibleSlots = employees.length * 7; // 7 days
        const coverageRate =
          totalPossibleSlots > 0
            ? Math.round((schedule.length / totalPossibleSlots) * 100)
            : 0;
        document.getElementById('coverage-rate').textContent =
          coverageRate + '%';
      }

      // Manager's Hours Calculator Functions
      function calculateHoursBalance() {
        try {
          const availableHoursEl = document.getElementById('available-hours');
          const managerScheduledHoursEl = document.getElementById(
            'manager-scheduled-hours'
          );
          const balanceElement = document.getElementById('hours-balance');
          const statusElement = document.getElementById('balance-status');

          if (
            !availableHoursEl ||
            !managerScheduledHoursEl ||
            !balanceElement ||
            !statusElement
          ) {
            console.warn(
              'Some balance elements not found, skipping balance calculation'
            );
            return;
          }

          const availableHours = parseFloat(availableHoursEl.value) || 0;
          const scheduledHours =
            parseFloat(managerScheduledHoursEl.textContent) || 0;
          const balance = availableHours - scheduledHours;

          balanceElement.textContent = Math.round(balance * 10) / 10;

          if (availableHours === 0) {
            balanceElement.className = 'text-2xl font-bold text-gray-500';
            statusElement.textContent = 'Enter available hours to see balance';
            statusElement.className = 'text-xs text-gray-600 mt-1';
          } else if (balance > 0) {
            balanceElement.className = 'text-2xl font-bold text-green-600';
            statusElement.textContent = `${balance.toFixed(
              1
            )} hours remaining to schedule`;
            statusElement.className = 'text-xs text-green-600 mt-1';
          } else if (balance < 0) {
            balanceElement.className = 'text-2xl font-bold text-red-600';
            statusElement.textContent = `${Math.abs(balance).toFixed(
              1
            )} hours over budget`;
            statusElement.className = 'text-xs text-red-600 mt-1';
          } else {
            balanceElement.className = 'text-2xl font-bold text-blue-600';
            statusElement.textContent = 'Perfect balance - all hours scheduled';
            statusElement.className = 'text-xs text-blue-600 mt-1';
          }
        } catch (error) {
          console.error('Error in calculateHoursBalance:', error);
        }
      }

      function suggestOptimalSchedule() {
        const availableHours = parseFloat(
          document.getElementById('available-hours').value
        );

        if (!availableHours || availableHours <= 0) {
          alert('Please enter the total available hours first.');
          document.getElementById('available-hours').focus();
          return;
        }

        const scheduledHours =
          parseFloat(
            document.getElementById('manager-scheduled-hours').textContent
          ) || 0;
        const employeeCount = allEmployees.length;

        if (employeeCount === 0) {
          alert('No employees found. Please add employees first.');
          return;
        }

        const averageHoursPerEmployee = availableHours / employeeCount;
        const currentBalance = availableHours - scheduledHours;

        let suggestion = `üìä Schedule Optimization Suggestions:\n\n`;
        suggestion += `‚Ä¢ Total Available Hours: ${availableHours}\n`;
        suggestion += `‚Ä¢ Currently Scheduled: ${scheduledHours}\n`;
        suggestion += `‚Ä¢ Remaining Hours: ${currentBalance.toFixed(1)}\n`;
        suggestion += `‚Ä¢ Average per Employee: ${averageHoursPerEmployee.toFixed(
          1
        )} hours\n\n`;

        if (currentBalance > 0) {
          suggestion += `üí° You have ${currentBalance.toFixed(
            1
          )} hours remaining to schedule.\n`;
          suggestion += `Consider adding more shifts or extending existing ones.`;
        } else if (currentBalance < 0) {
          suggestion += `‚ö†Ô∏è You are ${Math.abs(currentBalance).toFixed(
            1
          )} hours over budget.\n`;
          suggestion += `Consider reducing some shifts or removing unnecessary coverage.`;
        } else {
          suggestion += `‚úÖ Perfect! You have optimally scheduled all available hours.`;
        }

        alert(suggestion);
      }

      function exportHoursReport() {
        const availableHours =
          parseFloat(document.getElementById('available-hours').value) || 0;
        const scheduledHours =
          parseFloat(
            document.getElementById('manager-scheduled-hours').textContent
          ) || 0;
        const balance = availableHours - scheduledHours;

        // Create detailed report
        let report = `DUNHAM'S SPORTS - WEEKLY HOURS REPORT\n`;
        report += `Week of: ${
          document.getElementById('week-range').textContent
        }\n`;
        report += `Generated: ${new Date().toLocaleString()}\n`;
        report += `Manager: ${
          document.getElementById('current-user-name').textContent
        }\n\n`;

        report += `HOURS SUMMARY:\n`;
        report += `Available Hours: ${availableHours}\n`;
        report += `Scheduled Hours: ${scheduledHours}\n`;
        report += `Balance: ${balance.toFixed(1)} ${
          balance >= 0 ? '(remaining)' : '(over budget)'
        }\n\n`;

        report += `EMPLOYEE BREAKDOWN:\n`;
        allEmployees.forEach((emp) => {
          const empHours = calculateEmployeeWeeklyHours(
            emp.name,
            scheduleData.schedule || []
          );
          report += `${emp.name} (${emp.role}): ${empHours} hours\n`;
        });

        // Create downloadable file
        const blob = new Blob([report], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `hours-report-${
          new Date().toISOString().split('T')[0]
        }.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        showNotification('Hours report exported successfully!', 'success');
      }

      function resetHoursCalculator() {
        if (confirm('Are you sure you want to reset the hours calculator?')) {
          document.getElementById('available-hours').value = '';
          calculateHoursBalance();
          showNotification('Hours calculator reset', 'info');
        }
      }

      // Notification System
      function showNotification(message, type = 'info', duration = 5000) {
        const container = document.getElementById('notification-container');
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;

        container.appendChild(notification);

        setTimeout(() => {
          notification.style.animation = 'slideIn 0.3s ease-out reverse';
          setTimeout(() => {
            if (container.contains(notification)) {
              container.removeChild(notification);
            }
          }, 300);
        }, duration);
      }

      // Enhanced error handling
      function handleFailure(error) {
        hideLoader();
        console.error('Error:', error);
        showNotification(
          'An error occurred: ' + (error.message || error),
          'error'
        );
      }

      // Bulk Schedule Modal
      function openBulkScheduleModal() {
        const modal = document.getElementById('bulk-schedule-modal');
        const checkboxContainer = document.getElementById(
          'employee-checkboxes'
        );
        const shiftSelect = document.getElementById('bulk-shift-select');

        // Populate employees
        checkboxContainer.innerHTML = '';
        allEmployees.forEach((emp) => {
          const label = document.createElement('label');
          label.className = 'flex items-center mb-2';
          label.innerHTML = `
            <input type="checkbox" value="${emp.name}" class="mr-2">
            <span>${emp.name} (${emp.role})</span>
          `;
          checkboxContainer.appendChild(label);
        });

        // Populate shifts
        shiftSelect.innerHTML = '<option value="">Select a shift...</option>';
        allShifts.forEach((shift) => {
          const option = document.createElement('option');
          option.value = shift.name;
          option.textContent = `${shift.name} (${shift.start} - ${shift.end})`;
          shiftSelect.appendChild(option);
        });

        modal.style.display = 'flex';
      }

      function closeBulkScheduleModal() {
        document.getElementById('bulk-schedule-modal').style.display = 'none';
      }

      // Handle bulk schedule form
      document.addEventListener('DOMContentLoaded', function () {
        // Set up sign-in form listener
        const signinForm = document.getElementById('signin-form');
        if (signinForm) {
          signinForm.addEventListener('submit', handleSignIn);
        }

        const bulkForm = document.getElementById('bulk-schedule-form');
        if (bulkForm) {
          bulkForm.addEventListener('submit', function (e) {
            e.preventDefault();

            const selectedEmployees = Array.from(
              document.querySelectorAll('#employee-checkboxes input:checked')
            ).map((cb) => cb.value);
            const selectedShift =
              document.getElementById('bulk-shift-select').value;
            const selectedDays = Array.from(
              document.querySelectorAll(
                '#bulk-schedule-modal input[type="checkbox"]:checked'
              )
            )
              .map((cb) => parseInt(cb.value))
              .filter((day) => !isNaN(day));

            if (
              selectedEmployees.length === 0 ||
              !selectedShift ||
              selectedDays.length === 0
            ) {
              showNotification(
                'Please select employees, shift, and days',
                'warning'
              );
              return;
            }

            applyBulkSchedule(selectedEmployees, selectedShift, selectedDays);
          });
        }
      });

      function applyBulkSchedule(employees, shiftName, days) {
        showLoader();
        let completedRequests = 0;
        const totalRequests = employees.length * days.length;

        employees.forEach((employeeName) => {
          days.forEach((dayOfWeek) => {
            const targetDate = new Date(currentStartDate);
            const currentDay = targetDate.getDay();
            const daysToAdd = (dayOfWeek - currentDay + 7) % 7;
            targetDate.setDate(targetDate.getDate() + daysToAdd);

            google.script.run
              .withSuccessHandler(() => {
                completedRequests++;
                if (completedRequests === totalRequests) {
                  hideLoader();
                  showNotification(
                    'Bulk schedule applied successfully!',
                    'success'
                  );
                  closeBulkScheduleModal();
                  loadScheduleForDate(currentStartDate);
                }
              })
              .withFailureHandler((error) => {
                completedRequests++;
                console.error('Bulk schedule error:', error);
                if (completedRequests === totalRequests) {
                  hideLoader();
                  showNotification(
                    'Bulk schedule completed with some errors',
                    'warning'
                  );
                  closeBulkScheduleModal();
                  loadScheduleForDate(currentStartDate);
                }
              })
              .assignShift(
                employeeName,
                targetDate.toISOString().split('T')[0],
                shiftName
              );
          });
        });
      }

      // Export functionality
      function exportSchedule() {
        showLoader();
        google.script.run
          .withSuccessHandler((response) => {
            hideLoader();
            if (response.success) {
              showNotification('Schedule exported successfully!', 'success');
              // In a real implementation, this would trigger a download
              console.log('Export data:', response.data);
            } else {
              handleFailure(response);
            }
          })
          .withFailureHandler(handleFailure)
          .exportScheduleData(currentStartDate.getTime());
      }

      // Template Modal
      function openTemplateModal() {
        const modal = document.getElementById('template-modal');
        loadTemplates();
        modal.style.display = 'flex';
      }

      function closeTemplateModal() {
        document.getElementById('template-modal').style.display = 'none';
      }

      function saveCurrentAsTemplate() {
        const templateName = prompt('Enter template name:');
        if (templateName) {
          showLoader();
          google.script.run
            .withSuccessHandler((response) => {
              hideLoader();
              if (response.success) {
                showNotification('Template saved successfully!', 'success');
                loadTemplates();
              } else {
                handleFailure(response);
              }
            })
            .withFailureHandler(handleFailure)
            .saveScheduleTemplate(templateName, currentStartDate.getTime());
        }
      }

      function loadTemplates() {
        google.script.run
          .withSuccessHandler((response) => {
            if (response.success) {
              const container = document.getElementById('template-list');
              container.innerHTML = '';

              if (response.templates.length === 0) {
                container.innerHTML =
                  '<p class="text-gray-500 text-center">No templates saved yet</p>';
                return;
              }

              response.templates.forEach((template) => {
                const div = document.createElement('div');
                div.className =
                  'flex justify-between items-center p-3 bg-gray-50 rounded';
                div.innerHTML = `
                  <span>${template.name}</span>
                  <div>
                    <button onclick="applyTemplate('${template.id}')" class="px-3 py-1 bg-blue-500 text-white rounded text-sm mr-2">Apply</button>
                    <button onclick="deleteTemplate('${template.id}')" class="px-3 py-1 bg-red-500 text-white rounded text-sm">Delete</button>
                  </div>
                `;
                container.appendChild(div);
              });
            }
          })
          .withFailureHandler(handleFailure)
          .getScheduleTemplates();
      }

      // Analytics Modal
      function openAnalyticsModal() {
        const modal = document.getElementById('analytics-modal');
        loadAnalytics();
        modal.style.display = 'flex';
      }

      function closeAnalyticsModal() {
        document.getElementById('analytics-modal').style.display = 'none';
      }

      function loadAnalytics() {
        google.script.run
          .withSuccessHandler((response) => {
            if (response.success) {
              displayAnalytics(response.analytics);
            }
          })
          .withFailureHandler(handleFailure)
          .getScheduleAnalytics(currentStartDate.getTime());
      }

      function displayAnalytics(analytics) {
        // Employee Workload
        const workloadContainer = document.getElementById('workload-chart');
        workloadContainer.innerHTML = '';
        analytics.workload.forEach((item) => {
          const div = document.createElement('div');
          div.className = 'flex justify-between items-center';
          div.innerHTML = `
            <span>${item.employee}</span>
            <span class="font-bold">${item.hours}h</span>
          `;
          workloadContainer.appendChild(div);
        });

        // Shift Distribution
        const distributionContainer =
          document.getElementById('shift-distribution');
        distributionContainer.innerHTML = '';
        analytics.shiftDistribution.forEach((item) => {
          const div = document.createElement('div');
          div.className = 'flex justify-between items-center';
          div.innerHTML = `
            <span>${item.shift}</span>
            <span class="font-bold">${item.count}</span>
          `;
          distributionContainer.appendChild(div);
        });

        // Coverage Analysis
        const coverageContainer = document.getElementById('coverage-analysis');
        coverageContainer.innerHTML = `
          <p>Total Coverage: <strong>${analytics.coverage.total}%</strong></p>
          <p>Peak Hours: <strong>${analytics.coverage.peak}%</strong></p>
          <p>Off Hours: <strong>${analytics.coverage.offHours}%</strong></p>
        `;

        // Time Off Trends
        const trendsContainer = document.getElementById('timeoff-trends');
        trendsContainer.innerHTML = `
          <p>This Month: <strong>${analytics.timeOffTrends.thisMonth}</strong></p>
          <p>Last Month: <strong>${analytics.timeOffTrends.lastMonth}</strong></p>
          <p>Most Common Reason: <strong>${analytics.timeOffTrends.commonReason}</strong></p>
        `;
      }

      // Settings Modal
      function openSettingsModal() {
        const modal = document.getElementById('settings-modal');
        loadSettings();
        modal.style.display = 'flex';
      }

      function closeSettingsModal() {
        document.getElementById('settings-modal').style.display = 'none';
      }

      function loadSettings() {
        document.getElementById('auto-save').checked = appSettings.autoSave;
        document.getElementById('email-notifications').checked =
          appSettings.emailNotifications;
        document.getElementById('default-view').value = appSettings.defaultView;
        document.getElementById('time-format').value = appSettings.timeFormat;
      }

      function saveSettings() {
        appSettings.autoSave = document.getElementById('auto-save').checked;
        appSettings.emailNotifications = document.getElementById(
          'email-notifications'
        ).checked;
        appSettings.defaultView = document.getElementById('default-view').value;
        appSettings.timeFormat = document.getElementById('time-format').value;

        localStorage.setItem(
          'scheduleAppSettings',
          JSON.stringify(appSettings)
        );
        showNotification('Settings saved successfully!', 'success');
        closeSettingsModal();
      }

      // Theme Toggle
      function toggleTheme() {
        const body = document.body;
        const themeButton = document.getElementById('theme-toggle');

        body.classList.toggle('dark-mode');
        appSettings.darkMode = body.classList.contains('dark-mode');

        themeButton.textContent = appSettings.darkMode ? '‚òÄÔ∏è' : 'üåô';
        localStorage.setItem(
          'scheduleAppSettings',
          JSON.stringify(appSettings)
        );
      }

      // Notification Center
      function openNotificationCenter() {
        showNotification('Notification center coming soon!', 'info');
      }

      // Time Off History Modal
      function openTimeOffHistoryModal() {
        showNotification('Time off history modal coming soon!', 'info');
      }

      // Load settings on startup
      function loadAppSettings() {
        const saved = localStorage.getItem('scheduleAppSettings');
        if (saved) {
          appSettings = { ...appSettings, ...JSON.parse(saved) };
        }

        if (appSettings.darkMode) {
          document.body.classList.add('dark-mode');
          document.getElementById('theme-toggle').textContent = '‚òÄÔ∏è';
        }
      }

      // Enhanced pending requests with count update
      function buildPendingRequestsView(response) {
        if (!response.success) {
          handleFailure(response);
          return;
        }

        // Update pending count in dashboard
        document.getElementById('pending-count').textContent =
          response.requests.length;

        const container = document.getElementById('pending-requests-container');
        if (response.requests.length === 0) {
          container.innerHTML =
            '<p class="p-4 text-center text-gray-500">No pending time off requests.</p>';
          return;
        }

        let tableHtml = `
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dates</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reason</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
      `;
        response.requests.forEach((req) => {
          tableHtml += `
          <tr id="request-${req.requestId}" class="employee-row">
            <td class="px-4 py-4 whitespace-nowrap text-sm">${req.employeeName}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm">${req.startDate} to ${req.endDate}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm">${req.reason}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm space-x-2">
              <button onclick="processRequest('${req.requestId}', 'Approved')" class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 transition-colors">Approve</button>
              <button onclick="processRequest('${req.requestId}', 'Denied')" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">Deny</button>
            </td>
          </tr>
        `;
        });
        tableHtml += `</tbody></table>`;
        container.innerHTML = tableHtml;
      }

      // Enhanced process request with notifications
      function processRequest(requestId, status) {
        showLoader();
        google.script.run
          .withSuccessHandler((response) => {
            hideLoader();
            if (response.success) {
              showNotification(
                `Request ${status.toLowerCase()} successfully!`,
                'success'
              );
              loadPendingRequests();
              loadScheduleForDate(currentStartDate);
            } else {
              handleFailure(response);
            }
          })
          .withFailureHandler(handleFailure)
          .processTimeOffRequest(requestId, status);
      }

      // --- Time Entry Modal Management Functions ---

      /**
       * Opens the time entry modal for scheduling a shift
       * @param {string} employeeName - Name of the employee
       * @param {string} date - Date in ISO format (YYYY-MM-DD)
       * @param {object|null} assignment - Existing assignment object or null for new assignment
       */
      function openTimeEntryModal(employeeName, date, assignment) {
        // Store context
        currentModalContext = {
          employeeName: employeeName,
          date: date,
          existingAssignment: assignment,
        };

        // Populate modal header
        document.getElementById('modal-employee-name').textContent =
          employeeName;
        document.getElementById('modal-date').textContent =
          formatDateDisplay(date);

        // Populate shift selector dropdown
        const shiftSelect = document.getElementById('modal-shift-select');
        shiftSelect.innerHTML = '<option value="">-- Select Shift --</option>';
        allShifts.forEach((shift) => {
          const hours = calculateShiftHours(shift.start, shift.end);
          shiftSelect.innerHTML += `<option value="${shift.name}">${shift.name} (${shift.start} - ${shift.end}) - ${hours}h</option>`;
        });

        // Handle editing existing assignment
        if (assignment) {
          if (assignment.isCustom) {
            // Switch to custom mode
            document.querySelector(
              'input[name="shift-mode"][value="custom"]'
            ).checked = true;
            toggleShiftMode('custom');
            document.getElementById('custom-start-time').value =
              assignment.start;
            document.getElementById('custom-end-time').value = assignment.end;
            document.getElementById('overnight-checkbox').checked =
              assignment.isOvernight || false;
            calculateCustomDuration();
          } else {
            // Predefined mode
            document.querySelector(
              'input[name="shift-mode"][value="predefined"]'
            ).checked = true;
            toggleShiftMode('predefined');
            shiftSelect.value = assignment.shiftName;
            updateTimePreview();
          }
        } else {
          // New assignment - default to predefined mode
          document.querySelector(
            'input[name="shift-mode"][value="predefined"]'
          ).checked = true;
          toggleShiftMode('predefined');
        }

        // Show modal
        document.getElementById('time-entry-modal').style.display = 'flex';
      }

      /**
       * Closes the time entry modal and resets context
       */
      function closeTimeEntryModal() {
        document.getElementById('time-entry-modal').style.display = 'none';
        currentModalContext = {
          employeeName: null,
          date: null,
          existingAssignment: null,
        };
      }

      /**
       * Toggles between predefined shift and custom time entry modes
       * @param {string} mode - Either 'predefined' or 'custom'
       */
      function toggleShiftMode(mode) {
        const predefinedSection = document.getElementById(
          'predefined-shift-section'
        );
        const customSection = document.getElementById('custom-time-section');

        if (mode === 'predefined') {
          predefinedSection.classList.remove('hidden');
          customSection.classList.add('hidden');
          updateTimePreview();
        } else {
          predefinedSection.classList.add('hidden');
          customSection.classList.remove('hidden');
          calculateCustomDuration();
        }
      }

      /**
       * Formats an ISO date string for display
       * @param {string} dateStr - Date in ISO format (YYYY-MM-DD)
       * @returns {string} Formatted date string
       */
      function formatDateDisplay(dateStr) {
        const date = new Date(dateStr + 'T00:00:00');
        return date.toLocaleDateString('en-US', {
          weekday: 'long',
          month: 'long',
          day: 'numeric',
          year: 'numeric',
        });
      }

      /**
       * Validates time format (HH:MM)
       * @param {string} timeStr - Time string to validate
       * @returns {boolean} True if valid HH:MM format
       */
      function validateTimeFormat(timeStr) {
        if (!timeStr) {
          console.log('validateTimeFormat: Empty time string');
          return false;
        }
        const timeRegex = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
        const isValid = timeRegex.test(timeStr);
        console.log(
          `validateTimeFormat: "${timeStr}" is ${isValid ? 'valid' : 'invalid'}`
        );
        return isValid;
      }

      /**
       * Validates that end time is after start time
       * @param {string} startTime - Start time in HH:MM format
       * @param {string} endTime - End time in HH:MM format
       * @returns {boolean} True if end time is after start time
       */
      function validateTimeOrder(startTime, endTime) {
        if (!startTime || !endTime) {
          console.log('validateTimeOrder: Missing start or end time');
          return false;
        }
        const start = new Date(`2000-01-01 ${startTime}`);
        const end = new Date(`2000-01-01 ${endTime}`);
        const isValid = end > start;
        console.log(
          `validateTimeOrder: ${startTime} to ${endTime} is ${
            isValid ? 'valid' : 'invalid'
          }`
        );
        return isValid;
      }

      // Placeholder functions for time calculation and data persistence
      // These will be implemented in subsequent tasks

      function calculateCustomDuration() {
        const startTime = document.getElementById('custom-start-time').value;
        const endTime = document.getElementById('custom-end-time').value;
        const isOvernight =
          document.getElementById('overnight-checkbox').checked;

        if (!startTime || !endTime) {
          document.getElementById('shift-duration').textContent = '--';
          document.getElementById('time-range-display').textContent = '';
          return;
        }

        const hours = calculateShiftHours(startTime, endTime, isOvernight);
        document.getElementById(
          'shift-duration'
        ).textContent = `${hours} hours`;

        const overnightText = isOvernight ? ' (continues to next day)' : '';
        document.getElementById(
          'time-range-display'
        ).textContent = `${startTime} - ${endTime}${overnightText}`;
      }

      function updateTimePreview() {
        const shiftSelect = document.getElementById('modal-shift-select');
        const shiftName = shiftSelect.value;

        if (!shiftName) {
          document.getElementById('shift-duration').textContent = '--';
          document.getElementById('time-range-display').textContent = '';
          return;
        }

        const shift = allShifts.find((s) => s.name === shiftName);
        if (shift) {
          const hours = calculateShiftHours(shift.start, shift.end);
          document.getElementById(
            'shift-duration'
          ).textContent = `${hours} hours`;
          document.getElementById(
            'time-range-display'
          ).textContent = `${shift.start} - ${shift.end}`;
        }
      }

      function saveShiftAssignment() {
        const { employeeName, date } = currentModalContext;
        const mode = document.querySelector(
          'input[name="shift-mode"]:checked'
        ).value;

        let newAssignment = null;

        if (mode === 'predefined') {
          const shiftName = document.getElementById('modal-shift-select').value;
          if (!shiftName) {
            showNotification('Please select a shift', 'warning');
            return;
          }

          const shift = allShifts.find((s) => s.name === shiftName);
          newAssignment = {
            employeeName,
            date,
            shiftName: shift.name,
            start: shift.start,
            end: shift.end,
            isCustom: false,
            isOvernight: false,
          };
        } else {
          const startTime = document.getElementById('custom-start-time').value;
          const endTime = document.getElementById('custom-end-time').value;
          const isOvernight =
            document.getElementById('overnight-checkbox').checked;

          if (!startTime || !endTime) {
            showNotification(
              'Please enter both start and end times',
              'warning'
            );
            return;
          }

          // Validate time format
          if (!validateTimeFormat(startTime) || !validateTimeFormat(endTime)) {
            showNotification('Please enter times in HH:MM format', 'warning');
            return;
          }

          // Validate time order for non-overnight shifts
          if (!isOvernight && !validateTimeOrder(startTime, endTime)) {
            showNotification(
              'End time must be after start time, or check "overnight shift"',
              'warning'
            );
            return;
          }

          newAssignment = {
            employeeName,
            date,
            shiftName: 'Custom',
            start: startTime,
            end: endTime,
            isCustom: true,
            isOvernight,
          };
        }

        // Update schedule in localStorage
        let schedule = JSON.parse(localStorage.getItem('schedule') || '[]');

        // Remove existing assignment for this employee and date
        schedule = schedule.filter(
          (s) => !(s.employeeName === employeeName && s.date === date)
        );

        // Add new assignment
        schedule.push(newAssignment);

        // Save
        localStorage.setItem('schedule', JSON.stringify(schedule));

        // Close modal and refresh
        closeTimeEntryModal();
        showNotification('Shift saved successfully', 'success');
        loadScheduleForDate(currentStartDate);
      }

      function clearShift() {
        const { employeeName, date } = currentModalContext;

        if (!confirm('Are you sure you want to clear this shift?')) {
          return;
        }

        // Remove assignment from schedule
        let schedule = JSON.parse(localStorage.getItem('schedule') || '[]');
        schedule = schedule.filter(
          (s) => !(s.employeeName === employeeName && s.date === date)
        );
        localStorage.setItem('schedule', JSON.stringify(schedule));

        // Close modal and refresh
        closeTimeEntryModal();
        showNotification('Shift cleared', 'info');
        loadScheduleForDate(currentStartDate);
      }
    </script>
  </body>
</html>
