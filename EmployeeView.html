<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <script>
      // Make user data available to JavaScript
      window.templateUser = <?= JSON.stringify(user) ?>;
      console.log('Template user data loaded:', window.templateUser);
    </script>
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        min-height: 100vh;
      }

      /* Dunham's Sports Brand Colors */
      .brand-red {
        color: #e53e3e;
      }
      .brand-red-bg {
        background-color: #e53e3e;
      }
      .brand-red-border {
        border-color: #e53e3e;
      }

      /* Enhanced header styling */
      .brand-header {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border-bottom: 4px solid #e53e3e;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      /* Enhanced button styling */
      .btn-primary {
        background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
        border: none;
        color: white;
        transition: all 0.3s ease;
      }
      .btn-primary:hover {
        background: linear-gradient(135deg, #c53030 0%, #b91c1c 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(229, 62, 62, 0.3);
      }

      /* Enhanced card styling */
      .card-enhanced {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border-top: 3px solid #e53e3e;
        transition: all 0.3s ease;
      }
      .card-enhanced:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }
      .loader {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      #loader-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
      }
      /* Added styles for the modal */
      #time-off-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none; /* Initially hidden */
        align-items: center;
        justify-content: center;
        z-index: 200;
      }
      #modal-content {
        background: white;
        padding: 2rem;
        border-radius: 1rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
        width: 90%;
        max-width: 500px;
        position: relative;
        animation: fadeIn 0.3s ease-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .schedule-card {
        transition: all 0.2s ease;
      }
      .schedule-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }
      .stats-mini {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 0.5rem;
        padding: 1rem;
        text-align: center;
      }
      .close-button {
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 1.5rem;
        font-weight: bold;
        color: #6b7280;
        cursor: pointer;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <div id="loader-overlay"><div class="loader"></div></div>

    <!-- Time Off Request Modal -->
    <div id="time-off-modal">
      <div id="modal-content">
        <span class="close-button" onclick="closeTimeOffModal()">&times;</span>
        <h2 class="text-2xl font-bold mb-6 text-gray-800">Request Time Off</h2>
        <form id="time-off-form">
          <div class="mb-4">
            <label
              for="startDate"
              class="block text-gray-700 text-sm font-bold mb-2"
              >Start Date:</label
            >
            <input
              type="date"
              name="startDate"
              class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
              required
            />
          </div>
          <div class="mb-4">
            <label
              for="endDate"
              class="block text-gray-700 text-sm font-bold mb-2"
              >End Date:</label
            >
            <input
              type="date"
              name="endDate"
              class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
              required
            />
          </div>
          <div class="mb-6">
            <label
              for="reason"
              class="block text-gray-700 text-sm font-bold mb-2"
              >Reason (Optional):</label
            >
            <textarea
              name="reason"
              rows="3"
              class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
            ></textarea>
          </div>
          <button
            type="submit"
            class="w-full btn-primary font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
          >
            Submit Request
          </button>
        </form>
      </div>
    </div>

    <div class="container mx-auto p-4 md:p-8">
      <header class="brand-header p-6 rounded-lg mb-6">
        <div class="flex flex-col md:flex-row justify-between items-center">
          <div class="flex items-center space-x-4 mb-4 md:mb-0">
            <div class="flex items-center">
              <img src="https://i.imgur.com/g4pLt36.png" alt="Dunham's Sports Logo" class="mr-3" style="height: 40px;">
            </div>
            <div class="border-l-2 border-gray-300 pl-4">
              <h1 class="text-xl md:text-2xl font-bold text-gray-800">
                Staff Scheduling
              </h1>
              <p class="text-sm text-gray-600">Employee Dashboard</p>
            </div>
          </div>
          <div class="flex items-center space-x-4">
            <div class="text-right">
              <p class="text-sm text-gray-600">Signed in as</p>
              <p class="font-semibold" id="current-user-name">Loading...</p>
            </div>
            <button
              onclick="navigateWeek(-7)"
              class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold"
            >
              &lt; Prev
            </button>
            <h2 id="week-range" class="text-lg font-semibold text-center w-48">
              Loading...
            </h2>
            <button
              onclick="navigateWeek(7)"
              class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold"
            >
              Next &gt;
            </button>
          </div>
          <button
            onclick="openTimeOffModal()"
            class="mt-4 md:mt-0 w-full md:w-auto px-6 py-2 bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg shadow-sm"
          >
            Request Time Off
          </button>
        </div>
      </header>

      <!-- Mini Stats -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div class="stats-mini">
          <div class="text-2xl font-bold" id="hours-this-week">-</div>
          <div class="text-sm opacity-80">Hours This Week</div>
        </div>
        <div
          class="stats-mini"
          style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%)"
        >
          <div class="text-2xl font-bold" id="shifts-this-week">-</div>
          <div class="text-sm opacity-80">Shifts This Week</div>
        </div>
        <div
          class="stats-mini"
          style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)"
        >
          <div class="text-2xl font-bold" id="pending-requests">-</div>
          <div class="text-sm opacity-80">Pending Requests</div>
        </div>
        <div
          class="stats-mini"
          style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)"
        >
          <div class="text-2xl font-bold" id="next-shift">-</div>
          <div class="text-sm opacity-80">Next Shift</div>
        </div>
      </div>

      <h2 class="text-xl font-bold text-gray-700 mt-8 mb-4">My Schedule</h2>
      <main id="schedule-container" class="space-y-4">
        <!-- Schedule cards will be inserted here by JavaScript -->
      </main>

      <h2 class="text-xl font-bold text-gray-700 mt-8 mb-4">
        My Time Off Requests
      </h2>
      <div id="requests-container" class="card-enhanced p-4">
        <!-- Request history will be inserted here -->
      </div>
    </div>

    <script>
      let currentStartDate;

      function startApp() {
        try {
          if (google && google.script && google.script.run) {
            initializeApp();
          } else {
            setTimeout(startApp, 100);
          }
        } catch (e) {
          setTimeout(startApp, 100);
        }
      }

      function initializeApp() {
        // Try to load user from template first (fastest)
        if (loadUserFromTemplate()) {
          console.log('User loaded from template successfully');
        } else {
          // Fallback to server call
          console.log('Template user not available, loading from server...');
          loadCurrentUser();
        }

        // Fix date calculation
        const today = new Date();
        const dayOfWeek = today.getDay();
        const startDate = new Date(today);
        startDate.setHours(0, 0, 0, 0);

        // Calculate Monday of current week
        const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
        startDate.setDate(today.getDate() - daysFromMonday);

        currentStartDate = startDate;

        loadMySchedule(currentStartDate);
        loadMyRequests();
        document
          .getElementById('time-off-form')
          .addEventListener('submit', handleTimeOffSubmit);
      }

      // Load current user info
      function loadCurrentUser() {
        console.log('Loading current user info...');

        // Add timeout to detect if the call is hanging
        const timeout = setTimeout(() => {
          console.error('getCurrentUserInfo call timed out after 10 seconds');
          document.getElementById('current-user-name').textContent =
            'Timeout Error';
        }, 10000);

        // First try a simple test to see if server communication works
        google.script.run
          .withSuccessHandler((testResponse) => {
            console.log('Simple test successful:', testResponse);
            // Now try to get user info
            google.script.run
              .withSuccessHandler((response) => {
                clearTimeout(timeout);
                console.log('User info response:', response);
                if (response && response.success && response.user) {
                  document.getElementById('current-user-name').textContent =
                    response.user.name;
                } else {
                  console.error('User info failed:', response);
                  document.getElementById('current-user-name').textContent =
                    'Unknown User';
                }
              })
              .withFailureHandler((error) => {
                clearTimeout(timeout);
                console.error('Failed to load user info:', error);
                document.getElementById('current-user-name').textContent =
                  'Error Loading User';
              })
              .getCurrentUserInfo();
          })
          .withFailureHandler((error) => {
            clearTimeout(timeout);
            console.error('Simple test failed:', error);
            document.getElementById('current-user-name').textContent =
              'Server Connection Failed';
          })
          .simpleTest();
      }

      // Fallback function to load user from template data
      function loadUserFromTemplate() {
        console.log('Attempting to load user from template fallback...');
        // Check if there's a global user variable from the template
        if (
          typeof window.templateUser !== 'undefined' &&
          window.templateUser &&
          window.templateUser.name
        ) {
          document.getElementById('current-user-name').textContent =
            window.templateUser.name;
          console.log('Loaded user from template:', window.templateUser.name);
          return true;
        } else {
          console.log(
            'Template user not available or incomplete:',
            window.templateUser
          );
          return false;
        }
      }

      document.addEventListener('DOMContentLoaded', startApp);

      function showLoader() {
        document.getElementById('loader-overlay').style.display = 'flex';
      }
      function hideLoader() {
        document.getElementById('loader-overlay').style.display = 'none';
      }

      function handleFailure(error) {
        hideLoader();
        alert('An error occurred: \n' + JSON.stringify(error, null, 2));
      }

      // --- Schedule Functions ---
      function navigateWeek(days) {
        // Create a new date object to avoid mutation issues
        const newStartDate = new Date(currentStartDate.getTime());

        // Add the days (should be +7 or -7 for week navigation)
        newStartDate.setDate(newStartDate.getDate() + days);

        // Ensure we're still at the start of the week (Monday)
        const dayOfWeek = newStartDate.getDay();
        const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
        newStartDate.setDate(newStartDate.getDate() - daysFromMonday);

        currentStartDate = newStartDate;

        console.log(
          'Employee view navigating to week starting:',
          currentStartDate.toDateString()
        );

        loadMySchedule(currentStartDate);
      }

      function loadMySchedule(date) {
        showLoader();
        google.script.run
          .withSuccessHandler(buildScheduleView)
          .withFailureHandler(handleFailure)
          .getMySchedule(date.getTime());
      }

      function buildScheduleView(response) {
        hideLoader();
        if (!response.success) {
          handleFailure(response);
          return;
        }

        const { mySchedule, weekRange } = response;
        document.getElementById('week-range').textContent = weekRange;

        // Update mini stats
        updateMiniStats(mySchedule);

        const container = document.getElementById('schedule-container');
        container.innerHTML = '';

        if (!mySchedule || mySchedule.length === 0) {
          container.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-md text-center text-gray-500">You have nothing scheduled for this week.</div>`;
          return;
        }

        mySchedule.forEach((item) => {
          const dateParts = item.date.split('-'); // e.g., "2023-10-27"
          // Create date as UTC to avoid timezone shifts from the server string
          const itemDate = new Date(
            Date.UTC(dateParts[0], dateParts[1] - 1, dateParts[2])
          );

          const dayName = itemDate.toLocaleDateString('en-US', {
            weekday: 'long',
            timeZone: 'UTC',
          });
          const dateString = itemDate.toLocaleDateString('en-US', {
            month: 'long',
            day: 'numeric',
            timeZone: 'UTC',
          });

          let contentHtml;
          let cardClass = 'bg-white';
          if (item.shiftName === 'Time Off') {
            contentHtml = `<p class="text-lg font-semibold text-green-600">Approved Time Off</p>`;
            cardClass = 'bg-green-50';
          } else {
            contentHtml = `
            <p class="text-lg font-semibold text-gray-800">${item.shiftName}</p>
            <p class="text-md text-gray-600">${item.start} - ${item.end}</p>
            `;
          }

          const card = `
          <div class="${cardClass} p-6 rounded-lg shadow-md flex items-center space-x-6">
            <div class="text-center w-24">
              <p class="text-xl font-bold text-blue-600">${dayName}</p>
              <p class="text-sm text-gray-500">${dateString}</p>
            </div>
            <div class="border-l-2 border-gray-200 pl-6">
              ${contentHtml}
            </div>
          </div>
        `;
          container.innerHTML += card;
        });
      }

      // --- Time Off Request Functions ---
      function openTimeOffModal() {
        document.getElementById('time-off-modal').style.display = 'flex';
      }

      function closeTimeOffModal() {
        document.getElementById('time-off-modal').style.display = 'none';
      }

      function handleTimeOffSubmit(event) {
        event.preventDefault();
        showLoader();
        const form = event.target;
        const formData = new FormData(form);
        const formObject = {};
        formData.forEach((value, key) => (formObject[key] = value));

        if (new Date(formObject.endDate) < new Date(formObject.startDate)) {
          hideLoader();
          alert('End date cannot be before the start date.');
          return;
        }

        google.script.run
          .withSuccessHandler((response) => {
            hideLoader();
            if (response.success) {
              alert(response.message);
              closeTimeOffModal();
              form.reset();
              loadMyRequests();
            } else {
              handleFailure(response);
            }
          })
          .withFailureHandler(handleFailure)
          .submitTimeOffRequest(formObject);
      }

      function loadMyRequests() {
        google.script.run
          .withSuccessHandler(buildRequestsView)
          .withFailureHandler(handleFailure)
          .getEmployeeTimeOffRequests();
      }

      function buildRequestsView(response) {
        if (!response.success) {
          handleFailure(response);
          return;
        }

        const container = document.getElementById('requests-container');
        if (response.requests.length === 0) {
          container.innerHTML =
            '<p class="text-center text-gray-500">You have not submitted any time off requests.</p>';
          return;
        }

        let tableHtml = `
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dates</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reason</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
      `;
        response.requests.forEach((req) => {
          let statusColor = 'text-yellow-600';
          if (req.status === 'Approved') statusColor = 'text-green-600';
          if (req.status === 'Denied') statusColor = 'text-red-600';

          tableHtml += `
          <tr>
            <td class="px-4 py-4 whitespace-nowrap text-sm">${req.startDate} to ${req.endDate}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm">${req.reason}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm font-bold ${statusColor}">${req.status}</td>
          </tr>
        `;
        });
        tableHtml += `</tbody></table>`;
        container.innerHTML = tableHtml;
      }

      // Mini Stats Update
      function updateMiniStats(mySchedule) {
        const workShifts = mySchedule.filter(
          (item) => item.shiftName !== 'Time Off'
        );
        const totalHours = workShifts.reduce((total, shift) => {
          if (shift.start && shift.end) {
            const start = new Date(`2000-01-01 ${shift.start}`);
            const end = new Date(`2000-01-01 ${shift.end}`);
            let hours = (end - start) / (1000 * 60 * 60);
            if (hours < 0) hours += 24; // Handle overnight shifts
            return total + hours;
          }
          return total;
        }, 0);

        document.getElementById('hours-this-week').textContent =
          Math.round(totalHours * 10) / 10;
        document.getElementById('shifts-this-week').textContent =
          workShifts.length;

        // Find next shift
        const today = new Date();
        const futureShifts = workShifts.filter(
          (shift) => new Date(shift.date) >= today
        );
        const nextShift = futureShifts.length > 0 ? futureShifts[0] : null;

        if (nextShift) {
          const nextDate = new Date(nextShift.date);
          const dayName = nextDate.toLocaleDateString('en-US', {
            weekday: 'short',
          });
          document.getElementById('next-shift').textContent = dayName;
        } else {
          document.getElementById('next-shift').textContent = 'None';
        }
      }

      // Enhanced schedule cards with better styling
      function buildScheduleView(response) {
        hideLoader();
        if (!response.success) {
          handleFailure(response);
          return;
        }

        const { mySchedule, weekRange } = response;
        document.getElementById('week-range').textContent = weekRange;

        // Update mini stats
        updateMiniStats(mySchedule);

        const container = document.getElementById('schedule-container');
        container.innerHTML = '';

        if (!mySchedule || mySchedule.length === 0) {
          container.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-md text-center text-gray-500">You have nothing scheduled for this week.</div>`;
          return;
        }

        mySchedule.forEach((item) => {
          const dateParts = item.date.split('-');
          const itemDate = new Date(
            Date.UTC(dateParts[0], dateParts[1] - 1, dateParts[2])
          );

          const dayName = itemDate.toLocaleDateString('en-US', {
            weekday: 'long',
            timeZone: 'UTC',
          });
          const dateString = itemDate.toLocaleDateString('en-US', {
            month: 'long',
            day: 'numeric',
            timeZone: 'UTC',
          });

          let contentHtml;
          let cardClass = 'bg-white schedule-card';
          let iconHtml = '';

          if (item.shiftName === 'Time Off') {
            contentHtml = `<p class="text-lg font-semibold text-green-600">Approved Time Off</p>`;
            cardClass = 'bg-green-50 schedule-card';
            iconHtml = '<span class="text-2xl">🏖️</span>';
          } else {
            contentHtml = `
            <p class="text-lg font-semibold text-gray-800">${item.shiftName}</p>
            <p class="text-md text-gray-600">${item.start} - ${item.end}</p>
            `;
            iconHtml = '<span class="text-2xl">💼</span>';
          }

          const card = `
          <div class="${cardClass} p-6 rounded-lg shadow-md flex items-center space-x-6">
            <div class="text-center w-24">
              <p class="text-xl font-bold text-blue-600">${dayName}</p>
              <p class="text-sm text-gray-500">${dateString}</p>
            </div>
            <div class="border-l-2 border-gray-200 pl-6 flex-1">
              <div class="flex items-center space-x-3">
                ${iconHtml}
                <div>${contentHtml}</div>
              </div>
            </div>
          </div>
        `;
          container.innerHTML += card;
        });
      }

      // Enhanced request loading with count update
      function loadMyRequests() {
        google.script.run
          .withSuccessHandler((response) => {
            buildRequestsView(response);
            if (response.success) {
              const pendingCount = response.requests.filter(
                (req) => req.status === 'Pending'
              ).length;
              document.getElementById('pending-requests').textContent =
                pendingCount;
            }
          })
          .withFailureHandler(handleFailure)
          .getEmployeeTimeOffRequests();
      }
    </script>

    <!-- Footer -->
    <footer class="mt-12 py-6 border-t border-gray-200">
      <div class="container mx-auto px-4 text-center">
        <div class="flex items-center justify-center space-x-2 mb-2">
          <svg width="80" height="26" viewBox="0 0 300 100">
            <defs>
              <style>
                .footer-logo-text {
                  fill: #6b7280;
                  font-family: 'Arial Black', Arial, sans-serif;
                  font-weight: 900;
                }
                .footer-logo-sports {
                  fill: #6b7280;
                  font-family: Arial, sans-serif;
                  font-weight: bold;
                  letter-spacing: 2px;
                }
              </style>
            </defs>
            <text x="10" y="45" class="footer-logo-text" font-size="24">
              Dunham's
            </text>
            <text x="12" y="70" class="footer-logo-sports" font-size="10">
              S P O R T S
            </text>
          </svg>
        </div>
        <p class="text-sm text-gray-500">Staff Scheduling System</p>
        <p class="text-xs text-gray-400 mt-1">
          © 2024 Dunham's Sports. All rights reserved.
        </p>
      </div>
    </footer>
  </body>
</html>
