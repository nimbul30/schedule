<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <script>
      // Make user data available to JavaScript
      window.templateUser = <?= JSON.stringify(user) ?>;
      console.log('Template user data loaded:', window.templateUser);
    </script>
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        min-height: 100vh;
      }

      /* Dunham's Sports Brand Colors */
      .brand-red {
        color: #e53e3e;
      }
      .brand-red-bg {
        background-color: #e53e3e;
      }
      .brand-red-border {
        border-color: #e53e3e;
      }

      /* Enhanced header styling */
      .brand-header {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border-bottom: 4px solid #e53e3e;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      /* Enhanced button styling */
      .btn-primary {
        background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
        border: none;
        color: white;
        transition: all 0.3s ease;
      }
      .btn-primary:hover {
        background: linear-gradient(135deg, #c53030 0%, #b91c1c 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(229, 62, 62, 0.3);
      }

      /* Enhanced card styling */
      .card-enhanced {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border-top: 3px solid #e53e3e;
        transition: all 0.3s ease;
      }
      .card-enhanced:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }
      .loader {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes slideIn {
        from {
          transform: translateX(-100%);
        }
        to {
          transform: translateX(0);
        }
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      #loader-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
        backdrop-filter: blur(2px);
      }
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 200;
        backdrop-filter: blur(3px);
      }
      .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 1rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
        width: 90%;
        max-width: 500px;
        position: relative;
        animation: fadeIn 0.3s ease-out;
        max-height: 90vh;
        overflow-y: auto;
      }
      .close-button {
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 1.5rem;
        font-weight: bold;
        color: #6b7280;
        cursor: pointer;
        transition: color 0.2s;
      }
      .close-button:hover {
        color: #374151;
      }
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        color: white;
        font-weight: 500;
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
        max-width: 400px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }
      .notification.success {
        background-color: #10b981;
      }
      .notification.error {
        background-color: #ef4444;
      }
      .notification.warning {
        background-color: #f59e0b;
      }
      .notification.info {
        background-color: #3b82f6;
      }
      .shift-cell {
        transition: all 0.2s ease;
      }
      .shift-cell:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }
      .employee-row {
        transition: background-color 0.2s ease;
      }
      .employee-row:hover {
        background-color: #f9fafb;
      }
      .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 1rem;
        animation: fadeIn 0.5s ease-out;
      }
      .quick-action-btn {
        transition: all 0.2s ease;
        transform: translateY(0);
      }
      .quick-action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }
      .schedule-table {
        border-collapse: separate;
        border-spacing: 0;
      }
      .schedule-table th,
      .schedule-table td {
        border: 1px solid #e5e7eb;
      }
      .schedule-table th:first-child,
      .schedule-table td:first-child {
        border-left: none;
      }
      .schedule-table th:last-child,
      .schedule-table td:last-child {
        border-right: none;
      }
      .schedule-table thead th {
        border-top: none;
      }
      .schedule-table tbody tr:last-child td {
        border-bottom: none;
      }
      .dark-mode {
        background-color: #1f2937;
        color: #f9fafb;
      }
      .dark-mode .bg-white {
        background-color: #374151 !important;
        color: #f9fafb;
      }
      .dark-mode .text-gray-800 {
        color: #f9fafb !important;
      }
      .dark-mode .text-gray-600 {
        color: #d1d5db !important;
      }
      .dark-mode .border-gray-200 {
        border-color: #4b5563 !important;
      }
      .theme-toggle {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 50;
        background: #4f46e5;
        color: white;
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        cursor: pointer;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
      }
      .theme-toggle:hover {
        transform: scale(1.1);
        background: #4338ca;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <div id="loader-overlay"><div class="loader"></div></div>

    <!-- Admin Modal -->
    <div id="admin-modal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeAdminModal()">√ó</span>
        <div id="admin-form-container"></div>
      </div>
    </div>

    <!-- Bulk Schedule Modal -->
    <div id="bulk-schedule-modal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeBulkScheduleModal()">√ó</span>
        <h2 class="text-2xl font-bold mb-6 text-gray-800">
          Bulk Schedule Assignment
        </h2>
        <form id="bulk-schedule-form">
          <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2"
              >Select Employees:</label
            >
            <div
              id="employee-checkboxes"
              class="max-h-40 overflow-y-auto border rounded p-3"
            >
              <!-- Employee checkboxes will be populated here -->
            </div>
          </div>
          <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2"
              >Select Shift:</label
            >
            <select
              id="bulk-shift-select"
              class="w-full p-2 border rounded"
              required
            >
              <option value="">Select a shift...</option>
            </select>
          </div>
          <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2"
              >Select Days:</label
            >
            <div class="grid grid-cols-7 gap-2">
              <label class="flex items-center"
                ><input type="checkbox" value="1" class="mr-1" /> Mon</label
              >
              <label class="flex items-center"
                ><input type="checkbox" value="2" class="mr-1" /> Tue</label
              >
              <label class="flex items-center"
                ><input type="checkbox" value="3" class="mr-1" /> Wed</label
              >
              <label class="flex items-center"
                ><input type="checkbox" value="4" class="mr-1" /> Thu</label
              >
              <label class="flex items-center"
                ><input type="checkbox" value="5" class="mr-1" /> Fri</label
              >
              <label class="flex items-center"
                ><input type="checkbox" value="6" class="mr-1" /> Sat</label
              >
              <label class="flex items-center"
                ><input type="checkbox" value="0" class="mr-1" /> Sun</label
              >
            </div>
          </div>
          <button
            type="submit"
            class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded"
          >
            Apply Bulk Schedule
          </button>
        </form>
      </div>
    </div>

    <!-- Template Modal -->
    <div id="template-modal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeTemplateModal()">√ó</span>
        <h2 class="text-2xl font-bold mb-6 text-gray-800">
          Schedule Templates
        </h2>
        <div class="mb-4">
          <button
            onclick="saveCurrentAsTemplate()"
            class="w-full mb-3 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded"
          >
            Save Current Week as Template
          </button>
        </div>
        <div id="template-list" class="space-y-2">
          <!-- Templates will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Analytics Modal -->
    <div id="analytics-modal" class="modal">
      <div class="modal-content" style="max-width: 800px">
        <span class="close-button" onclick="closeAnalyticsModal()">√ó</span>
        <h2 class="text-2xl font-bold mb-6 text-gray-800">
          Schedule Analytics
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="bg-gray-50 p-4 rounded-lg">
            <h3 class="font-bold mb-3">Employee Workload</h3>
            <div id="workload-chart" class="space-y-2">
              <!-- Workload data will be displayed here -->
            </div>
          </div>
          <div class="bg-gray-50 p-4 rounded-lg">
            <h3 class="font-bold mb-3">Shift Distribution</h3>
            <div id="shift-distribution" class="space-y-2">
              <!-- Shift distribution will be displayed here -->
            </div>
          </div>
          <div class="bg-gray-50 p-4 rounded-lg">
            <h3 class="font-bold mb-3">Coverage Analysis</h3>
            <div id="coverage-analysis">
              <!-- Coverage analysis will be displayed here -->
            </div>
          </div>
          <div class="bg-gray-50 p-4 rounded-lg">
            <h3 class="font-bold mb-3">Time Off Trends</h3>
            <div id="timeoff-trends">
              <!-- Time off trends will be displayed here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeSettingsModal()">√ó</span>
        <h2 class="text-2xl font-bold mb-6 text-gray-800">Settings</h2>
        <div class="space-y-4">
          <div>
            <label class="flex items-center">
              <input type="checkbox" id="auto-save" class="mr-2" />
              <span>Auto-save changes</span>
            </label>
          </div>
          <div>
            <label class="flex items-center">
              <input type="checkbox" id="email-notifications" class="mr-2" />
              <span>Email notifications</span>
            </label>
          </div>
          <div>
            <label class="block text-gray-700 text-sm font-bold mb-2"
              >Default Week View:</label
            >
            <select id="default-view" class="w-full p-2 border rounded">
              <option value="current">Current Week</option>
              <option value="next">Next Week</option>
            </select>
          </div>
          <div>
            <label class="block text-gray-700 text-sm font-bold mb-2"
              >Time Format:</label
            >
            <select id="time-format" class="w-full p-2 border rounded">
              <option value="12">12-hour (AM/PM)</option>
              <option value="24">24-hour</option>
            </select>
          </div>
          <button
            onclick="saveSettings()"
            class="w-full btn-primary font-bold py-2 px-4 rounded"
          >
            Save Settings
          </button>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div
      id="delete-modal"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center"
      style="display: none; z-index: 300"
    >
      <div
        id="delete-modal-content"
        class="bg-white p-8 rounded-lg shadow-xl w-11/12 max-w-md mx-auto"
      >
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Confirm Deletion</h2>
        <p id="delete-modal-text" class="mb-4 text-gray-600">
          This action cannot be undone. This will permanently delete the
          employee and all their future scheduled shifts. Please type
          <strong class="text-red-600">delete</strong> to confirm.
        </p>
        <input
          type="text"
          id="delete-confirm-input"
          class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-4"
          placeholder="delete"
        />
        <div class="flex justify-end space-x-4">
          <button
            onclick="closeDeleteModal()"
            class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400 font-semibold"
          >
            Cancel
          </button>
          <button
            id="confirm-delete-btn"
            onclick="confirmEmployeeDeletion()"
            class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-semibold disabled:bg-red-300"
            disabled
          >
            Delete Employee
          </button>
        </div>
      </div>
    </div>

    <div class="container mx-auto p-4 md:p-8">
      <header class="brand-header p-6 rounded-lg mb-6">
        <div class="flex flex-col md:flex-row justify-between items-center">
          <div class="flex items-center space-x-4 mb-4 md:mb-0">
            <div class="flex items-center">
              <svg width="120" height="40" viewBox="0 0 300 100" class="mr-3">
                <defs>
                  <style>
                    .logo-text {
                      fill: #e53e3e;
                      font-family: 'Arial Black', Arial, sans-serif;
                      font-weight: 900;
                    }
                    .logo-sports {
                      fill: #e53e3e;
                      font-family: Arial, sans-serif;
                      font-weight: bold;
                      letter-spacing: 3px;
                    }
                  </style>
                </defs>
                <text x="10" y="45" class="logo-text" font-size="32">
                  Dunham's
                </text>
                <text x="15" y="75" class="logo-sports" font-size="14">
                  S P O R T S
                </text>
              </svg>
            </div>
            <div class="border-l-2 border-gray-300 pl-4">
              <h1 class="text-xl md:text-2xl font-bold text-gray-800">
                Staff Scheduling
              </h1>
              <p class="text-sm text-gray-600">Management Dashboard</p>
            </div>
          </div>
          <div class="flex items-center space-x-2 md:space-x-4">
            <div class="text-right">
              <p class="text-sm text-gray-600">Signed in as</p>
              <p class="font-semibold" id="current-user-name">Loading...</p>
            </div>
            <button
              onclick="navigateWeek(-7)"
              class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold"
            >
              &lt; Prev
            </button>
            <h2 id="week-range" class="text-lg font-semibold text-center w-48">
              Loading...
            </h2>
            <button
              onclick="navigateWeek(7)"
              class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold"
            >
              Next &gt;
            </button>
          </div>
          <div
            class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 mt-4 md:mt-0"
          >
            <!-- Admin Buttons -->
            <button
              onclick="openAdminModal('employee')"
              class="w-full md:w-auto px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg shadow-sm"
            >
              Add Employee
            </button>
            <button
              onclick="openAdminModal('shift')"
              class="w-full md:w-auto px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-lg shadow-sm"
            >
              Add Shift
            </button>
            <button
              onclick="publishCurrentSchedule()"
              class="w-full md:w-auto px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-sm"
            >
              Publish Schedule
            </button>
          </div>
        </div>
      </header>

      <!-- Dashboard Stats -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="stats-card">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm opacity-80">Total Employees</p>
              <p id="total-employees" class="text-3xl font-bold">-</p>
            </div>
            <div class="text-4xl opacity-60">üë•</div>
          </div>
        </div>
        <div
          class="stats-card"
          style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%)"
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm opacity-80">Scheduled This Week</p>
              <p id="scheduled-count" class="text-3xl font-bold">-</p>
            </div>
            <div class="text-4xl opacity-60">üìÖ</div>
          </div>
        </div>
        <div
          class="stats-card"
          style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)"
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm opacity-80">Pending Requests</p>
              <p id="pending-count" class="text-3xl font-bold">-</p>
            </div>
            <div class="text-4xl opacity-60">‚è≥</div>
          </div>
        </div>
        <div
          class="stats-card"
          style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)"
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm opacity-80">Coverage Rate</p>
              <p id="coverage-rate" class="text-3xl font-bold">-%</p>
            </div>
            <div class="text-4xl opacity-60">üìä</div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card-enhanced p-6 mb-8">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Quick Actions</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
          <button
            onclick="openBulkScheduleModal()"
            class="quick-action-btn flex flex-col items-center p-4 bg-purple-100 hover:bg-purple-200 rounded-lg text-purple-700"
          >
            <span class="text-2xl mb-2">‚ö°</span>
            <span class="text-sm font-medium">Bulk Schedule</span>
          </button>
          <button
            onclick="exportSchedule()"
            class="quick-action-btn flex flex-col items-center p-4 bg-blue-100 hover:bg-blue-200 rounded-lg text-blue-700"
          >
            <span class="text-2xl mb-2">üì§</span>
            <span class="text-sm font-medium">Export</span>
          </button>
          <button
            onclick="openTemplateModal()"
            class="quick-action-btn flex flex-col items-center p-4 bg-green-100 hover:bg-green-200 rounded-lg text-green-700"
          >
            <span class="text-2xl mb-2">üìã</span>
            <span class="text-sm font-medium">Templates</span>
          </button>
          <button
            onclick="openAnalyticsModal()"
            class="quick-action-btn flex flex-col items-center p-4 bg-yellow-100 hover:bg-yellow-200 rounded-lg text-yellow-700"
          >
            <span class="text-2xl mb-2">üìà</span>
            <span class="text-sm font-medium">Analytics</span>
          </button>
          <button
            onclick="openNotificationCenter()"
            class="quick-action-btn flex flex-col items-center p-4 bg-red-100 hover:bg-red-200 rounded-lg text-red-700"
          >
            <span class="text-2xl mb-2">üîî</span>
            <span class="text-sm font-medium">Notifications</span>
          </button>
          <button
            onclick="openSettingsModal()"
            class="quick-action-btn flex flex-col items-center p-4 bg-gray-100 hover:bg-gray-200 rounded-lg text-gray-700"
          >
            <span class="text-2xl mb-2">‚öôÔ∏è</span>
            <span class="text-sm font-medium">Settings</span>
          </button>
        </div>
      </div>

      <!-- Time Off Requests Section -->
      <div class="mb-8">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold text-gray-700">
            Pending Time Off Requests
          </h2>
          <button
            onclick="openTimeOffHistoryModal()"
            class="px-4 py-2 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-lg font-medium transition-colors"
          >
            View History
          </button>
        </div>
        <div id="pending-requests-container" class="card-enhanced">
          <!-- Pending requests will be inserted here -->
        </div>
      </div>

      <!-- Schedule Section -->
      <h2 class="text-xl font-bold text-gray-700 mb-4">Weekly Schedule</h2>
      <main class="card-enhanced overflow-x-auto">
        <table
          id="schedule-table"
          class="min-w-full divide-y divide-gray-200"
        ></table>
      </main>
    </div>

    <!-- Theme Toggle Button -->
    <button
      id="theme-toggle"
      class="theme-toggle"
      onclick="toggleTheme()"
      title="Toggle Dark Mode"
    >
      üåô
    </button>

    <!-- Notification Container -->
    <div
      id="notification-container"
      style="position: fixed; top: 20px; right: 20px; z-index: 1000"
    ></div>

    <script>
      let currentStartDate;
      let allShifts = [];
      let allEmployees = [];
      let employeeToDeleteEmail = null;
      let scheduleData = {};
      let appSettings = {
        autoSave: true,
        emailNotifications: true,
        defaultView: 'current',
        timeFormat: '12',
        darkMode: false,
      };

      function startApp() {
        try {
          if (google && google.script && google.script.run) {
            initializeApp();
          } else {
            setTimeout(startApp, 100);
          }
        } catch (e) {
          setTimeout(startApp, 100);
        }
      }

      function initializeApp() {
        console.log('Initializing app...');

        // Test server connection first
        testServerConnection();

        // Load user info first
        loadCurrentUser();

        // Fix date calculation to properly handle week boundaries
        const today = new Date();
        const dayOfWeek = today.getDay();
        const startDate = new Date(today);
        startDate.setHours(0, 0, 0, 0);

        // Calculate Monday of current week (0 = Sunday, 1 = Monday, etc.)
        const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
        startDate.setDate(today.getDate() - daysFromMonday);

        currentStartDate = startDate;

        console.log('Current week start:', startDate.toDateString());

        loadScheduleForDate(currentStartDate);
        loadPendingRequests();
      }

      function testServerConnection() {
        console.log('Testing server connection...');

        // Test the simple function first
        google.script.run
          .withSuccessHandler((response) => {
            console.log('Simple test response:', response);
          })
          .withFailureHandler((error) => {
            console.error('Simple test failed:', error);
          })
          .simpleTest();

        // Then test the server connection
        google.script.run
          .withSuccessHandler((response) => {
            console.log('Server test response:', response);
          })
          .withFailureHandler((error) => {
            console.error('Server test failed:', error);
          })
          .testServerConnection();
      }

      document.addEventListener('DOMContentLoaded', startApp);

      // Load current user info
      function loadCurrentUser() {
        console.log('Loading current user info...');

        // Add timeout to detect if the call is hanging
        const timeout = setTimeout(() => {
          console.error('getCurrentUserInfo call timed out after 10 seconds');
          document.getElementById('current-user-name').textContent =
            'Timeout Error';
        }, 10000);

        // First try a simple test to see if server communication works
        google.script.run
          .withSuccessHandler((testResponse) => {
            console.log('Simple test successful:', testResponse);
            // Now try to get user info
            google.script.run
              .withSuccessHandler((response) => {
                clearTimeout(timeout);
                console.log('User info response:', response);
                if (response && response.success && response.user) {
                  document.getElementById('current-user-name').textContent =
                    response.user.name;
                } else {
                  console.error('User info failed:', response);
                  document.getElementById('current-user-name').textContent =
                    'Unknown User';
                }
              })
              .withFailureHandler((error) => {
                clearTimeout(timeout);
                console.error('Failed to load user info:', error);
                document.getElementById('current-user-name').textContent =
                  'Error Loading User';
              })
              .getCurrentUserInfo();
          })
          .withFailureHandler((error) => {
            clearTimeout(timeout);
            console.error('Simple test failed:', error);
            document.getElementById('current-user-name').textContent =
              'Server Connection Failed';
          })
          .simpleTest();
      }

      function showLoader() {
        document.getElementById('loader-overlay').style.display = 'flex';
      }
      function hideLoader() {
        document.getElementById('loader-overlay').style.display = 'none';
      }

      function handleFailure(error) {
        hideLoader();
        console.error('Application error:', error);

        // Show user-friendly error message
        let errorMessage = 'An error occurred while loading data.';
        if (error && error.message) {
          errorMessage += '\n\nDetails: ' + error.message;
        } else if (typeof error === 'string') {
          errorMessage += '\n\nDetails: ' + error;
        }

        alert(errorMessage);
      }

      // --- Schedule Functions ---
      function navigateWeek(days) {
        // Create a new date object to avoid mutation issues
        const newStartDate = new Date(currentStartDate.getTime());

        // Add the days (should be +7 or -7 for week navigation)
        newStartDate.setDate(newStartDate.getDate() + days);

        // Ensure we're still at the start of the week (Monday)
        const dayOfWeek = newStartDate.getDay();
        const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
        newStartDate.setDate(newStartDate.getDate() - daysFromMonday);

        currentStartDate = newStartDate;

        console.log(
          'Navigating to week starting:',
          currentStartDate.toDateString()
        );

        loadScheduleForDate(currentStartDate);
      }

      function loadScheduleForDate(date) {
        console.log(
          'Loading schedule for date:',
          date.toDateString(),
          'Timestamp:',
          date.getTime()
        );
        showLoader();
        google.script.run
          .withSuccessHandler(handleServerResponse)
          .withFailureHandler(handleFailure)
          .getScheduleDataForWebApp(date.getTime());
      }

      function handleServerResponse(response) {
        hideLoader();
        console.log('Server response received:', response);

        if (response === null || response === undefined) {
          console.error('Received null/undefined response from server');
          handleFailure({
            error: 'Server returned null response. Please check server logs.',
          });
          return;
        }

        if (response && response.success) {
          buildScheduleGrid(response);
        } else {
          console.error('Server response indicates failure:', response);
          handleFailure(response);
        }
      }

      function buildScheduleGrid(data) {
        const { employees, shifts, schedule, weekRange, approvedRequests } =
          data;
        allShifts = shifts || [];
        allEmployees = employees || [];
        scheduleData = data;

        // Update dashboard stats
        updateDashboardStats(data);

        document.getElementById('week-range').textContent = weekRange;
        const table = document.getElementById('schedule-table');
        table.innerHTML = '';
        const thead = table.createTHead();
        const headerRow = thead.insertRow();
        headerRow.className = 'bg-gray-50';
        let th = document.createElement('th');
        th.className =
          'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
        th.textContent = 'Staff';
        headerRow.appendChild(th);
        const dateColumns = [];
        for (let i = 0; i < 7; i++) {
          const d = new Date(currentStartDate);
          d.setDate(d.getDate() + i);
          dateColumns.push(d.toISOString().split('T')[0]);
          th = document.createElement('th');
          th.className =
            'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
          th.textContent = d.toLocaleDateString('en-US', {
            weekday: 'short',
            month: 'short',
            day: 'numeric',
          });
          headerRow.appendChild(th);
        }
        const tbody = table.createTBody();
        tbody.className = 'bg-white divide-y divide-gray-200';
        if (!employees || employees.length === 0) {
          const row = tbody.insertRow();
          const cell = row.insertCell();
          cell.colSpan = 8;
          cell.className = 'px-6 py-10 text-center text-gray-500';
          cell.textContent =
            'No employees found. Click "Add Employee" to begin.';
        } else {
          employees.forEach((emp) => {
            const row = tbody.insertRow();
            let cell = row.insertCell();
            cell.className =
              'px-6 py-4 whitespace-nowrap flex justify-between items-center';
            cell.innerHTML = `
              <div>
                <div class="font-medium text-gray-900">${emp.name}</div>
                <div class="text-sm text-gray-500">${emp.role}</div>
              </div>
              <button onclick="openDeleteModal('${emp.name}', '${emp.email}')" class="ml-4 px-2 py-1 text-xs font-medium text-red-600 bg-red-100 rounded-md hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                  Delete
              </button>
            `;

            dateColumns.forEach((date) => {
              cell = row.insertCell();
              cell.className = 'px-6 py-4 whitespace-nowrap';
              const dateParts = date.split('-');
              const currentDate = new Date(
                Date.UTC(dateParts[0], dateParts[1] - 1, dateParts[2])
              );

              const isOnLeave =
                approvedRequests &&
                approvedRequests.some((req) => {
                  const startDate = new Date(req.startDate);
                  const endDate = new Date(req.endDate);
                  return (
                    emp.email === req.employeeEmail &&
                    currentDate >= startDate &&
                    currentDate <= endDate
                  );
                });

              if (isOnLeave) {
                cell.innerHTML = `<div class="p-2 text-center font-semibold text-white bg-green-500 rounded-md">Time Off</div>`;
                cell.className += ' bg-green-100';
              } else {
                const assignment = schedule.find(
                  (s) => s.employeeName === emp.name && s.date === date
                );
                cell.innerHTML = createShiftSelector(
                  emp.name,
                  date,
                  assignment ? assignment.shiftName : ''
                );
              }
            });
          });
        }
      }

      function createShiftSelector(employeeName, date, selectedShift) {
        let selectHTML = `<select class='w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500' onchange='handleShiftChange(this, "${employeeName}", "${date}")'>`;
        selectHTML += `<option value=''>-- Unassigned --</option>`;
        allShifts.forEach((shift) => {
          const isSelected = shift.name === selectedShift ? 'selected' : '';
          selectHTML += `<option value='${shift.name}' ${isSelected}>${shift.name} (${shift.start} - ${shift.end})</option>`;
        });
        selectHTML += `</select>`;
        return selectHTML;
      }

      function handleShiftChange(selectElement, employeeName, date) {
        showLoader();
        google.script.run
          .withSuccessHandler((response) => {
            hideLoader();
            if (!response.success) {
              handleFailure(response);
            }
          })
          .withFailureHandler(handleFailure)
          .assignShift(employeeName, date, selectElement.value);
      }

      function publishCurrentSchedule() {
        if (
          confirm(
            'Are you sure you want to publish the schedule for the current week? This will create a new sheet in your Google Spreadsheet.'
          )
        ) {
          showLoader();
          google.script.run
            .withSuccessHandler((response) => {
              hideLoader();
              if (response.success) {
                alert(response.message);
              } else {
                handleFailure(response);
              }
            })
            .withFailureHandler(handleFailure)
            .publishSchedule(currentStartDate.getTime());
        }
      }

      // --- Admin Modal Functions ---
      function openAdminModal(formType) {
        showLoader();
        google.script.run
          .withSuccessHandler((html) => {
            hideLoader();
            const modal = document.getElementById('admin-modal');
            const formContainer = document.getElementById(
              'admin-form-container'
            );
            formContainer.innerHTML = html;
            modal.style.display = 'flex';
            const form = formContainer.querySelector('form');
            form.addEventListener('submit', handleAdminFormSubmit);
          })
          .withFailureHandler(handleFailure)
          .getAdminFormHtml(formType);
      }

      function closeAdminModal() {
        const modal = document.getElementById('admin-modal');
        modal.style.display = 'none';
        document.getElementById('admin-form-container').innerHTML = '';
      }

      function handleAdminFormSubmit(event) {
        event.preventDefault();
        showLoader();
        const form = event.target;
        const formData = new FormData(form);
        const formObject = {};
        formData.forEach((value, key) => {
          formObject[key] = value;
        });

        google.script.run
          .withSuccessHandler((response) => {
            hideLoader();
            if (response.success) {
              alert(response.message);
              closeAdminModal();
              loadScheduleForDate(currentStartDate);
            } else {
              handleFailure(response);
            }
          })
          .withFailureHandler(handleFailure)
          .processAdminForm(formObject);
      }

      // --- Manager Time Off Request Functions ---
      function loadPendingRequests() {
        google.script.run
          .withSuccessHandler(buildPendingRequestsView)
          .withFailureHandler(handleFailure)
          .getPendingRequests();
      }

      function buildPendingRequestsView(response) {
        if (!response.success) {
          handleFailure(response);
          return;
        }
        const container = document.getElementById('pending-requests-container');
        if (response.requests.length === 0) {
          container.innerHTML =
            '<p class="p-4 text-center text-gray-500">No pending time off requests.</p>';
          return;
        }

        let tableHtml = `
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dates</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reason</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
      `;
        response.requests.forEach((req) => {
          tableHtml += `
          <tr id="request-${req.requestId}">
            <td class="px-4 py-4 whitespace-nowrap text-sm">${req.employeeName}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm">${req.startDate} to ${req.endDate}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm">${req.reason}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm space-x-2">
              <button onclick="processRequest('${req.requestId}', 'Approved')" class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600">Approve</button>
              <button onclick="processRequest('${req.requestId}', 'Denied')" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600">Deny</button>
            </td>
          </tr>
        `;
        });
        tableHtml += `</tbody></table>`;
        container.innerHTML = tableHtml;
      }

      function processRequest(requestId, status) {
        showLoader();
        google.script.run
          .withSuccessHandler((response) => {
            hideLoader();
            if (response.success) {
              alert(response.message);
              loadPendingRequests();
              loadScheduleForDate(currentStartDate);
            } else {
              handleFailure(response);
            }
          })
          .withFailureHandler(handleFailure)
          .processTimeOffRequest(requestId, status);
      }

      // --- Delete Employee Functions ---
      function openDeleteModal(employeeName, employeeEmail) {
        employeeToDeleteEmail = employeeEmail;
        const modal = document.getElementById('delete-modal');
        document.getElementById(
          'delete-modal-text'
        ).innerHTML = `This action cannot be undone. This will permanently delete <strong>${employeeName}</strong> and all their future scheduled shifts. Please type <strong class="text-red-600">delete</strong> to confirm.`;
        modal.style.display = 'flex';

        const deleteInput = document.getElementById('delete-confirm-input');
        const confirmBtn = document.getElementById('confirm-delete-btn');
        deleteInput.value = '';
        confirmBtn.disabled = true;

        deleteInput.oninput = function () {
          if (deleteInput.value.trim().toLowerCase() === 'delete') {
            confirmBtn.disabled = false;
          } else {
            confirmBtn.disabled = true;
          }
        };
      }

      function closeDeleteModal() {
        document.getElementById('delete-modal').style.display = 'none';
        employeeToDeleteEmail = null;
      }

      function confirmEmployeeDeletion() {
        if (!employeeToDeleteEmail) {
          alert('Error: No employee selected for deletion.');
          closeDeleteModal();
          return;
        }

        showLoader();
        google.script.run
          .withSuccessHandler((response) => {
            hideLoader();
            if (response.success) {
              alert(response.message);
              closeDeleteModal();
              loadScheduleForDate(currentStartDate);
            } else {
              handleFailure(response);
            }
          })
          .withFailureHandler(handleFailure)
          .deleteEmployee(employeeToDeleteEmail);
      }

      // Fallback function to load user from template data
      function loadUserFromTemplate() {
        console.log('Attempting to load user from template fallback...');
        // Check if there's a global user variable from the template
        if (
          typeof window.templateUser !== 'undefined' &&
          window.templateUser &&
          window.templateUser.name
        ) {
          document.getElementById('current-user-name').textContent =
            window.templateUser.name;
          console.log('Loaded user from template:', window.templateUser.name);
          return true;
        } else {
          console.log(
            'Template user not available or incomplete:',
            window.templateUser
          );
          return false;
        }
      }

      // --- Enhanced Features ---

      // Dashboard Statistics
      function updateDashboardStats(data) {
        const { employees, schedule, approvedRequests } = data;

        document.getElementById('total-employees').textContent =
          employees.length;
        document.getElementById('scheduled-count').textContent =
          schedule.length;
        document.getElementById('pending-count').textContent = '...'; // Will be updated by loadPendingRequests

        // Calculate coverage rate
        const totalPossibleSlots = employees.length * 7; // 7 days
        const coverageRate =
          totalPossibleSlots > 0
            ? Math.round((schedule.length / totalPossibleSlots) * 100)
            : 0;
        document.getElementById('coverage-rate').textContent =
          coverageRate + '%';
      }

      // Notification System
      function showNotification(message, type = 'info', duration = 5000) {
        const container = document.getElementById('notification-container');
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;

        container.appendChild(notification);

        setTimeout(() => {
          notification.style.animation = 'slideIn 0.3s ease-out reverse';
          setTimeout(() => {
            if (container.contains(notification)) {
              container.removeChild(notification);
            }
          }, 300);
        }, duration);
      }

      // Enhanced error handling
      function handleFailure(error) {
        hideLoader();
        console.error('Error:', error);
        showNotification(
          'An error occurred: ' + (error.message || error),
          'error'
        );
      }

      // Bulk Schedule Modal
      function openBulkScheduleModal() {
        const modal = document.getElementById('bulk-schedule-modal');
        const checkboxContainer = document.getElementById(
          'employee-checkboxes'
        );
        const shiftSelect = document.getElementById('bulk-shift-select');

        // Populate employees
        checkboxContainer.innerHTML = '';
        allEmployees.forEach((emp) => {
          const label = document.createElement('label');
          label.className = 'flex items-center mb-2';
          label.innerHTML = `
            <input type="checkbox" value="${emp.name}" class="mr-2">
            <span>${emp.name} (${emp.role})</span>
          `;
          checkboxContainer.appendChild(label);
        });

        // Populate shifts
        shiftSelect.innerHTML = '<option value="">Select a shift...</option>';
        allShifts.forEach((shift) => {
          const option = document.createElement('option');
          option.value = shift.name;
          option.textContent = `${shift.name} (${shift.start} - ${shift.end})`;
          shiftSelect.appendChild(option);
        });

        modal.style.display = 'flex';
      }

      function closeBulkScheduleModal() {
        document.getElementById('bulk-schedule-modal').style.display = 'none';
      }

      // Handle bulk schedule form
      document.addEventListener('DOMContentLoaded', function () {
        const bulkForm = document.getElementById('bulk-schedule-form');
        if (bulkForm) {
          bulkForm.addEventListener('submit', function (e) {
            e.preventDefault();

            const selectedEmployees = Array.from(
              document.querySelectorAll('#employee-checkboxes input:checked')
            ).map((cb) => cb.value);
            const selectedShift =
              document.getElementById('bulk-shift-select').value;
            const selectedDays = Array.from(
              document.querySelectorAll(
                '#bulk-schedule-modal input[type="checkbox"]:checked'
              )
            )
              .map((cb) => parseInt(cb.value))
              .filter((day) => !isNaN(day));

            if (
              selectedEmployees.length === 0 ||
              !selectedShift ||
              selectedDays.length === 0
            ) {
              showNotification(
                'Please select employees, shift, and days',
                'warning'
              );
              return;
            }

            applyBulkSchedule(selectedEmployees, selectedShift, selectedDays);
          });
        }
      });

      function applyBulkSchedule(employees, shiftName, days) {
        showLoader();
        let completedRequests = 0;
        const totalRequests = employees.length * days.length;

        employees.forEach((employeeName) => {
          days.forEach((dayOfWeek) => {
            const targetDate = new Date(currentStartDate);
            const currentDay = targetDate.getDay();
            const daysToAdd = (dayOfWeek - currentDay + 7) % 7;
            targetDate.setDate(targetDate.getDate() + daysToAdd);

            google.script.run
              .withSuccessHandler(() => {
                completedRequests++;
                if (completedRequests === totalRequests) {
                  hideLoader();
                  showNotification(
                    'Bulk schedule applied successfully!',
                    'success'
                  );
                  closeBulkScheduleModal();
                  loadScheduleForDate(currentStartDate);
                }
              })
              .withFailureHandler((error) => {
                completedRequests++;
                console.error('Bulk schedule error:', error);
                if (completedRequests === totalRequests) {
                  hideLoader();
                  showNotification(
                    'Bulk schedule completed with some errors',
                    'warning'
                  );
                  closeBulkScheduleModal();
                  loadScheduleForDate(currentStartDate);
                }
              })
              .assignShift(
                employeeName,
                targetDate.toISOString().split('T')[0],
                shiftName
              );
          });
        });
      }

      // Export functionality
      function exportSchedule() {
        showLoader();
        google.script.run
          .withSuccessHandler((response) => {
            hideLoader();
            if (response.success) {
              showNotification('Schedule exported successfully!', 'success');
              // In a real implementation, this would trigger a download
              console.log('Export data:', response.data);
            } else {
              handleFailure(response);
            }
          })
          .withFailureHandler(handleFailure)
          .exportScheduleData(currentStartDate.getTime());
      }

      // Template Modal
      function openTemplateModal() {
        const modal = document.getElementById('template-modal');
        loadTemplates();
        modal.style.display = 'flex';
      }

      function closeTemplateModal() {
        document.getElementById('template-modal').style.display = 'none';
      }

      function saveCurrentAsTemplate() {
        const templateName = prompt('Enter template name:');
        if (templateName) {
          showLoader();
          google.script.run
            .withSuccessHandler((response) => {
              hideLoader();
              if (response.success) {
                showNotification('Template saved successfully!', 'success');
                loadTemplates();
              } else {
                handleFailure(response);
              }
            })
            .withFailureHandler(handleFailure)
            .saveScheduleTemplate(templateName, currentStartDate.getTime());
        }
      }

      function loadTemplates() {
        google.script.run
          .withSuccessHandler((response) => {
            if (response.success) {
              const container = document.getElementById('template-list');
              container.innerHTML = '';

              if (response.templates.length === 0) {
                container.innerHTML =
                  '<p class="text-gray-500 text-center">No templates saved yet</p>';
                return;
              }

              response.templates.forEach((template) => {
                const div = document.createElement('div');
                div.className =
                  'flex justify-between items-center p-3 bg-gray-50 rounded';
                div.innerHTML = `
                  <span>${template.name}</span>
                  <div>
                    <button onclick="applyTemplate('${template.id}')" class="px-3 py-1 bg-blue-500 text-white rounded text-sm mr-2">Apply</button>
                    <button onclick="deleteTemplate('${template.id}')" class="px-3 py-1 bg-red-500 text-white rounded text-sm">Delete</button>
                  </div>
                `;
                container.appendChild(div);
              });
            }
          })
          .withFailureHandler(handleFailure)
          .getScheduleTemplates();
      }

      // Analytics Modal
      function openAnalyticsModal() {
        const modal = document.getElementById('analytics-modal');
        loadAnalytics();
        modal.style.display = 'flex';
      }

      function closeAnalyticsModal() {
        document.getElementById('analytics-modal').style.display = 'none';
      }

      function loadAnalytics() {
        google.script.run
          .withSuccessHandler((response) => {
            if (response.success) {
              displayAnalytics(response.analytics);
            }
          })
          .withFailureHandler(handleFailure)
          .getScheduleAnalytics(currentStartDate.getTime());
      }

      function displayAnalytics(analytics) {
        // Employee Workload
        const workloadContainer = document.getElementById('workload-chart');
        workloadContainer.innerHTML = '';
        analytics.workload.forEach((item) => {
          const div = document.createElement('div');
          div.className = 'flex justify-between items-center';
          div.innerHTML = `
            <span>${item.employee}</span>
            <span class="font-bold">${item.hours}h</span>
          `;
          workloadContainer.appendChild(div);
        });

        // Shift Distribution
        const distributionContainer =
          document.getElementById('shift-distribution');
        distributionContainer.innerHTML = '';
        analytics.shiftDistribution.forEach((item) => {
          const div = document.createElement('div');
          div.className = 'flex justify-between items-center';
          div.innerHTML = `
            <span>${item.shift}</span>
            <span class="font-bold">${item.count}</span>
          `;
          distributionContainer.appendChild(div);
        });

        // Coverage Analysis
        const coverageContainer = document.getElementById('coverage-analysis');
        coverageContainer.innerHTML = `
          <p>Total Coverage: <strong>${analytics.coverage.total}%</strong></p>
          <p>Peak Hours: <strong>${analytics.coverage.peak}%</strong></p>
          <p>Off Hours: <strong>${analytics.coverage.offHours}%</strong></p>
        `;

        // Time Off Trends
        const trendsContainer = document.getElementById('timeoff-trends');
        trendsContainer.innerHTML = `
          <p>This Month: <strong>${analytics.timeOffTrends.thisMonth}</strong></p>
          <p>Last Month: <strong>${analytics.timeOffTrends.lastMonth}</strong></p>
          <p>Most Common Reason: <strong>${analytics.timeOffTrends.commonReason}</strong></p>
        `;
      }

      // Settings Modal
      function openSettingsModal() {
        const modal = document.getElementById('settings-modal');
        loadSettings();
        modal.style.display = 'flex';
      }

      function closeSettingsModal() {
        document.getElementById('settings-modal').style.display = 'none';
      }

      function loadSettings() {
        document.getElementById('auto-save').checked = appSettings.autoSave;
        document.getElementById('email-notifications').checked =
          appSettings.emailNotifications;
        document.getElementById('default-view').value = appSettings.defaultView;
        document.getElementById('time-format').value = appSettings.timeFormat;
      }

      function saveSettings() {
        appSettings.autoSave = document.getElementById('auto-save').checked;
        appSettings.emailNotifications = document.getElementById(
          'email-notifications'
        ).checked;
        appSettings.defaultView = document.getElementById('default-view').value;
        appSettings.timeFormat = document.getElementById('time-format').value;

        localStorage.setItem(
          'scheduleAppSettings',
          JSON.stringify(appSettings)
        );
        showNotification('Settings saved successfully!', 'success');
        closeSettingsModal();
      }

      // Theme Toggle
      function toggleTheme() {
        const body = document.body;
        const themeButton = document.getElementById('theme-toggle');

        body.classList.toggle('dark-mode');
        appSettings.darkMode = body.classList.contains('dark-mode');

        themeButton.textContent = appSettings.darkMode ? '‚òÄÔ∏è' : 'üåô';
        localStorage.setItem(
          'scheduleAppSettings',
          JSON.stringify(appSettings)
        );
      }

      // Notification Center
      function openNotificationCenter() {
        showNotification('Notification center coming soon!', 'info');
      }

      // Time Off History Modal
      function openTimeOffHistoryModal() {
        showNotification('Time off history modal coming soon!', 'info');
      }

      // Load settings on startup
      function loadAppSettings() {
        const saved = localStorage.getItem('scheduleAppSettings');
        if (saved) {
          appSettings = { ...appSettings, ...JSON.parse(saved) };
        }

        if (appSettings.darkMode) {
          document.body.classList.add('dark-mode');
          document.getElementById('theme-toggle').textContent = '‚òÄÔ∏è';
        }
      }

      // Enhanced initialization
      function initializeApp() {
        loadAppSettings();

        const today = new Date();
        const dayOfWeek = today.getDay();
        const startDate = new Date(today);
        startDate.setHours(0, 0, 0, 0);
        startDate.setDate(
          today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1)
        );
        currentStartDate = startDate;

        loadScheduleForDate(currentStartDate);
        loadPendingRequests();

        showNotification(
          'Welcome to the Enhanced Scheduling Dashboard! üéâ',
          'success'
        );
      }

      // Enhanced pending requests with count update
      function buildPendingRequestsView(response) {
        if (!response.success) {
          handleFailure(response);
          return;
        }

        // Update pending count in dashboard
        document.getElementById('pending-count').textContent =
          response.requests.length;

        const container = document.getElementById('pending-requests-container');
        if (response.requests.length === 0) {
          container.innerHTML =
            '<p class="p-4 text-center text-gray-500">No pending time off requests.</p>';
          return;
        }

        let tableHtml = `
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dates</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reason</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
      `;
        response.requests.forEach((req) => {
          tableHtml += `
          <tr id="request-${req.requestId}" class="employee-row">
            <td class="px-4 py-4 whitespace-nowrap text-sm">${req.employeeName}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm">${req.startDate} to ${req.endDate}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm">${req.reason}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm space-x-2">
              <button onclick="processRequest('${req.requestId}', 'Approved')" class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 transition-colors">Approve</button>
              <button onclick="processRequest('${req.requestId}', 'Denied')" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">Deny</button>
            </td>
          </tr>
        `;
        });
        tableHtml += `</tbody></table>`;
        container.innerHTML = tableHtml;
      }

      // Enhanced process request with notifications
      function processRequest(requestId, status) {
        showLoader();
        google.script.run
          .withSuccessHandler((response) => {
            hideLoader();
            if (response.success) {
              showNotification(
                `Request ${status.toLowerCase()} successfully!`,
                'success'
              );
              loadPendingRequests();
              loadScheduleForDate(currentStartDate);
            } else {
              handleFailure(response);
            }
          })
          .withFailureHandler(handleFailure)
          .processTimeOffRequest(requestId, status);
      }
    </script>

    <!-- Footer -->
    <footer class="mt-12 py-6 border-t border-gray-200">
      <div class="container mx-auto px-4 text-center">
        <div class="flex items-center justify-center space-x-2 mb-2">
          <svg width="80" height="26" viewBox="0 0 300 100">
            <defs>
              <style>
                .footer-logo-text {
                  fill: #6b7280;
                  font-family: 'Arial Black', Arial, sans-serif;
                  font-weight: 900;
                }
                .footer-logo-sports {
                  fill: #6b7280;
                  font-family: Arial, sans-serif;
                  font-weight: bold;
                  letter-spacing: 2px;
                }
              </style>
            </defs>
            <text x="10" y="45" class="footer-logo-text" font-size="24">
              Dunham's
            </text>
            <text x="12" y="70" class="footer-logo-sports" font-size="10">
              S P O R T S
            </text>
          </svg>
        </div>
        <p class="text-sm text-gray-500">Staff Scheduling System</p>
        <p class="text-xs text-gray-400 mt-1">
          ¬© 2024 Dunham's Sports. All rights reserved.
        </p>
      </div>
    </footer>
  </body>
</html>
