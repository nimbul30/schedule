<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: 'Inter', sans-serif;
      }
      .loader {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      #loader-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
      }
      /* Added styles for the modal */
      #admin-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none; /* Initially hidden */
        align-items: center;
        justify-content: center;
        z-index: 200;
      }
      #admin-modal-content {
        background: white;
        padding: 2rem;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        width: 90%;
        max-width: 500px;
        position: relative;
      }
      .close-button {
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 1.5rem;
        font-weight: bold;
        color: #6b7280;
        cursor: pointer;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <div id="loader-overlay"><div class="loader"></div></div>

    <!-- Admin Modal -->
    <div id="admin-modal">
      <div id="admin-modal-content">
        <span class="close-button" onclick="closeAdminModal()">&times;</span>
        <div id="admin-form-container"></div>
      </div>
    </div>

    <div class="container mx-auto p-4 md:p-8">
      <header class="bg-white p-4 rounded-lg shadow-md mb-6">
        <div class="flex flex-col md:flex-row justify-between items-center">
          <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4 md:mb-0">
            Scheduling Dashboard
          </h1>
          <div class="flex items-center space-x-2 md:space-x-4">
            <button
              onclick="navigateWeek(-7)"
              class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold"
            >
              &lt; Prev
            </button>
            <h2 id="week-range" class="text-lg font-semibold text-center w-48">
              Loading...
            </h2>
            <button
              onclick="navigateWeek(7)"
              class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold"
            >
              Next &gt;
            </button>
          </div>
          <div
            class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 mt-4 md:mt-0"
          >
            <!-- Admin Buttons -->
            <button
              onclick="openAdminModal('employee')"
              class="w-full md:w-auto px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg shadow-sm"
            >
              Add Employee
            </button>
            <button
              onclick="openAdminModal('shift')"
              class="w-full md:w-auto px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-lg shadow-sm"
            >
              Add Shift
            </button>
            <button
              onclick="publishCurrentSchedule()"
              class="w-full md:w-auto px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-sm"
            >
              Publish Schedule
            </button>
          </div>
        </div>
      </header>

      <!-- Time Off Requests Section -->
      <div class="mb-8">
        <h2 class="text-xl font-bold text-gray-700 mb-4">
          Pending Time Off Requests
        </h2>
        <div
          id="pending-requests-container"
          class="bg-white rounded-lg shadow-md"
        >
          <!-- Pending requests will be inserted here -->
        </div>
      </div>

      <!-- Schedule Section -->
      <h2 class="text-xl font-bold text-gray-700 mb-4">Weekly Schedule</h2>
      <main class="bg-white rounded-lg shadow-md overflow-x-auto">
        <table
          id="schedule-table"
          class="min-w-full divide-y divide-gray-200"
        ></table>
      </main>
    </div>

    <script>
      let currentStartDate;
      let allShifts = [];

      document.addEventListener('DOMContentLoaded', function () {
        const today = new Date();
        const dayOfWeek = today.getDay();
        const startDate = new Date(today);
        startDate.setDate(
          today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1)
        );
        currentStartDate = startDate;
        loadScheduleForDate(currentStartDate);
        loadPendingRequests(); // Load pending requests on page load
      });

      function showLoader() {
        document.getElementById('loader-overlay').style.display = 'flex';
      }
      function hideLoader() {
        document.getElementById('loader-overlay').style.display = 'none';
      }
      function handleFailure(error) {
        hideLoader();
        // Check for custom error object from success handlers, otherwise use standard error message
        const errorMessage =
          error && error.error
            ? error.error
            : error && error.message
            ? error.message
            : 'An unknown error occurred.';
        alert('Error: ' + errorMessage);
      }

      // --- Schedule Functions ---
      function navigateWeek(days) {
        currentStartDate.setDate(currentStartDate.getDate() + days);
        loadScheduleForDate(currentStartDate);
      }

      function loadScheduleForDate(date) {
        showLoader();
        const dateString = date.toISOString().split('T')[0];
        google.script.run
          .withSuccessHandler(handleServerResponse)
          .withFailureHandler(handleFailure)
          .getScheduleDataForWebApp(dateString);
      }

      function handleServerResponse(response) {
        hideLoader();
        if (response && response.success) {
          buildScheduleGrid(response);
        } else {
          handleFailure(response);
        }
      }

      function buildScheduleGrid(data) {
        const { employees, shifts, schedule, weekRange, approvedRequests } =
          data;
        allShifts = shifts || [];
        document.getElementById('week-range').textContent = weekRange;
        const table = document.getElementById('schedule-table');
        table.innerHTML = '';
        const thead = table.createTHead();
        const headerRow = thead.insertRow();
        headerRow.className = 'bg-gray-50';
        let th = document.createElement('th');
        th.className =
          'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
        th.textContent = 'Staff';
        headerRow.appendChild(th);
        const dateColumns = [];
        for (let i = 0; i < 7; i++) {
          const d = new Date(currentStartDate);
          d.setDate(d.getDate() + i);
          dateColumns.push(d.toISOString().split('T')[0]);
          th = document.createElement('th');
          th.className =
            'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
          th.textContent = d.toLocaleDateString('en-US', {
            weekday: 'short',
            month: 'short',
            day: 'numeric',
          });
          headerRow.appendChild(th);
        }
        const tbody = table.createTBody();
        tbody.className = 'bg-white divide-y divide-gray-200';
        if (!employees || employees.length === 0) {
          const row = tbody.insertRow();
          const cell = row.insertCell();
          cell.colSpan = 8;
          cell.className = 'px-6 py-10 text-center text-gray-500';
          cell.textContent =
            'No employees found. Click "Add Employee" to begin.';
        } else {
          employees.forEach((emp) => {
            const row = tbody.insertRow();
            let cell = row.insertCell();
            cell.className = 'px-6 py-4 whitespace-nowrap';
            cell.innerHTML = `<div class="font-medium text-gray-900">${emp.name}</div><div class="text-sm text-gray-500">${emp.role}</div>`;
            dateColumns.forEach((date) => {
              cell = row.insertCell();
              cell.className = 'px-6 py-4 whitespace-nowrap';
              const currentDate = new Date(date + 'T00:00:00');
              const isOnLeave =
                approvedRequests &&
                approvedRequests.some(
                  (req) =>
                    emp.email === req.employeeEmail &&
                    currentDate >= new Date(req.startDate) &&
                    currentDate <= new Date(req.endDate)
                );

              if (isOnLeave) {
                cell.innerHTML = `<div class="p-2 text-center font-semibold text-white bg-green-500 rounded-md">Time Off</div>`;
                cell.className += ' bg-green-100';
              } else {
                const assignment = schedule.find(
                  (s) => s.employeeName === emp.name && s.date === date
                );
                cell.innerHTML = createShiftSelector(
                  emp.name,
                  date,
                  assignment ? assignment.shiftName : ''
                );
              }
            });
          });
        }
      }

      function createShiftSelector(employeeName, date, selectedShift) {
        let selectHTML = `<select class='w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500' onchange='handleShiftChange(this, "${employeeName}", "${date}")'>`;
        selectHTML += `<option value=''>-- Unassigned --</option>`;
        allShifts.forEach((shift) => {
          const isSelected = shift.name === selectedShift ? 'selected' : '';
          selectHTML += `<option value='${shift.name}' ${isSelected}>${shift.name} (${shift.start} - ${shift.end})</option>`;
        });
        selectHTML += `</select>`;
        return selectHTML;
      }

      function handleShiftChange(selectElement, employeeName, date) {
        showLoader();
        google.script.run
          .withSuccessHandler((response) => {
            hideLoader();
            if (!response.success) {
              alert('Error saving shift: ' + response.error);
            }
          })
          .withFailureHandler(handleFailure)
          .assignShift(employeeName, date, selectElement.value);
      }

      function publishCurrentSchedule() {
        if (
          confirm(
            'Are you sure you want to publish the schedule for the current week? This will create a new sheet in your Google Spreadsheet.'
          )
        ) {
          showLoader();
          const dateString = currentStartDate.toISOString().split('T')[0];
          google.script.run
            .withSuccessHandler((response) => {
              hideLoader();
              if (response.success) {
                alert(response.message);
              } else {
                handleFailure(response);
              }
            })
            .withFailureHandler(handleFailure)
            .publishSchedule(dateString);
        }
      }

      // --- Admin Modal Functions ---
      function openAdminModal(formType) {
        showLoader();
        google.script.run
          .withSuccessHandler((html) => {
            hideLoader();
            const modal = document.getElementById('admin-modal');
            const formContainer = document.getElementById(
              'admin-form-container'
            );
            formContainer.innerHTML = html;
            modal.style.display = 'flex';
            const form = formContainer.querySelector('form');
            form.addEventListener('submit', handleAdminFormSubmit);
          })
          .withFailureHandler(handleFailure)
          .getAdminFormHtml(formType);
      }

      function closeAdminModal() {
        const modal = document.getElementById('admin-modal');
        modal.style.display = 'none';
        document.getElementById('admin-form-container').innerHTML = '';
      }

      function handleAdminFormSubmit(event) {
        event.preventDefault();
        showLoader();
        const form = event.target;
        const formData = new FormData(form);
        const formObject = {};
        formData.forEach((value, key) => {
          formObject[key] = value;
        });

        google.script.run
          .withSuccessHandler((response) => {
            hideLoader();
            if (response.success) {
              alert(response.message);
              closeAdminModal();
              loadScheduleForDate(currentStartDate); // Reload data
            } else {
              handleFailure(response);
            }
          })
          .withFailureHandler(handleFailure)
          .processAdminForm(formObject);
      }

      // --- Manager Time Off Request Functions ---
      function loadPendingRequests() {
        google.script.run
          .withSuccessHandler(buildPendingRequestsView)
          .withFailureHandler(handleFailure)
          .getPendingRequests();
      }

      function buildPendingRequestsView(response) {
        if (!response.success) {
          handleFailure(response);
          return;
        }
        const container = document.getElementById('pending-requests-container');
        if (response.requests.length === 0) {
          container.innerHTML =
            '<p class="p-4 text-center text-gray-500">No pending time off requests.</p>';
          return;
        }

        let tableHtml = `
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dates</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reason</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
      `;
        response.requests.forEach((req) => {
          tableHtml += `
          <tr id="request-${req.requestId}">
            <td class="px-4 py-4 whitespace-nowrap text-sm">${req.employeeName}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm">${req.startDate} to ${req.endDate}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm">${req.reason}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm space-x-2">
              <button onclick="processRequest('${req.requestId}', 'Approved')" class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600">Approve</button>
              <button onclick="processRequest('${req.requestId}', 'Denied')" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600">Deny</button>
            </td>
          </tr>
        `;
        });
        tableHtml += `</tbody></table>`;
        container.innerHTML = tableHtml;
      }

      function processRequest(requestId, status) {
        showLoader();
        google.script.run
          .withSuccessHandler((response) => {
            hideLoader();
            if (response.success) {
              alert(response.message);
              loadPendingRequests(); // Refresh the list of pending requests
              loadScheduleForDate(currentStartDate); // Also refresh the main schedule
            } else {
              handleFailure(response);
            }
          })
          .withFailureHandler(handleFailure)
          .processTimeOffRequest(requestId, status);
      }
    </script>
  </body>
</html>
